<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="微信公众号, Android,Java,Python,C language,C#,C++,HTML,CSS,JavaScript,JQuery,Vue.js等"><meta name="description" content="成功的信念在人脑中的作用就如闹钟,会在你需要时将你唤醒"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><title>微信公众号 | Lj&#39;blog</title><link rel="icon" type="image/png" href="/liaojie.github.io/medias/dog.png"><link rel="stylesheet" type="text/css" href="/liaojie.github.io/libs/awesome/css/all.css"><link rel="stylesheet" type="text/css" href="/liaojie.github.io/libs/materialize/materialize.min.css"><link rel="stylesheet" type="text/css" href="/liaojie.github.io/libs/aos/aos.css"><link rel="stylesheet" type="text/css" href="/liaojie.github.io/libs/animate/animate.min.css"><link rel="stylesheet" type="text/css" href="/liaojie.github.io/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" type="text/css" href="/liaojie.github.io/css/matery.css"><link rel="stylesheet" type="text/css" href="/liaojie.github.io/css/my.css"><script src="/liaojie.github.io/libs/jquery/jquery.min.js"></script><meta name="generator" content="Hexo 5.4.0"><style>.github-emoji{position:relative;display:inline-block;width:1.2em;min-height:1.2em;overflow:hidden;vertical-align:top;color:transparent}.github-emoji>span{position:relative;z-index:10}.github-emoji .fancybox,.github-emoji img{margin:0!important;padding:0!important;border:none!important;outline:0!important;text-decoration:none!important;user-select:none!important;cursor:auto!important}.github-emoji img{height:1.2em!important;width:1.2em!important;position:absolute!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;user-select:none!important;cursor:auto!important}.github-emoji-fallback{color:inherit}.github-emoji-fallback img{opacity:0!important}</style><link rel="alternate" href="/liaojie.github.io/atom.xml" title="Lj'blog" type="application/atom+xml"></head><script type="text/javascript">WIDGET={FID:"1tFpFZ5Mtj"}</script><script type="text/javascript">var windowWidth=$(window).width();768<windowWidth&&document.write('<script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"><\/script>')</script><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/liaojie.github.io/" class="waves-effect waves-light"><div><img src="/liaojie.github.io/medias/loading.gif" data-original="/liaojie.github.io/medias/ljlogo.png" class="logo-img" alt="LOGO"> <span class="logo-span">Lj'blog</span></div></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/liaojie.github.io/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom:.6"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/liaojie.github.io/tags" class="waves-effect waves-light"><i class="fas fa-tags" style="zoom:.6"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/liaojie.github.io/categories" class="waves-effect waves-light"><i class="fas fa-bookmark" style="zoom:.6"></i> <span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/liaojie.github.io/archives" class="waves-effect waves-light"><i class="fas fa-archive" style="zoom:.6"></i> <span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/liaojie.github.io/about" class="waves-effect waves-light"><i class="fas fa-user-circle" style="zoom:.6"></i> <span>关于</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/liaojie.github.io/contact" class="waves-effect waves-light"><i class="fas fa-comments" style="zoom:.6"></i> <span>留言板</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/liaojie.github.io/friends" class="waves-effect waves-light"><i class="fas fa-address-book" style="zoom:.6"></i> <span>友情链接</span></a></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:.85"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="/liaojie.github.io/medias/loading.gif" data-original="/liaojie.github.io/liaojie.github.io/medias/ljlogo.png" class="logo-img circle responsive-img"><div class="logo-name">Lj&#39;blog</div><div class="logo-desc">成功的信念在人脑中的作用就如闹钟,会在你需要时将你唤醒</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/liaojie.github.io/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/liaojie.github.io/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/liaojie.github.io/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/liaojie.github.io/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/liaojie.github.io/about" class="waves-effect waves-light"><i class="fa-fw fas fa-user-circle"></i> 关于</a></li><li class="m-nav-item"><a href="/liaojie.github.io/contact" class="waves-effect waves-light"><i class="fa-fw fas fa-comments"></i> 留言板</a></li><li class="m-nav-item"><a href="/liaojie.github.io/friends" class="waves-effect waves-light"><i class="fa-fw fas fa-address-book"></i> 友情链接</a></li></ul></div></div></nav></header><div class="bg-cover pd-header post-cover" style="background-image:url(/liaojie.github.io/medias/featureimages/1.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">微信公众号</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="/liaojie.github.io/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{padding:35px 0 15px 17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{padding-bottom:30px;overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:15px;bottom:76px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/liaojie.github.io/tags/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7/"><span class="chip bg-color">微信公众号</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/liaojie.github.io/categories/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7/" class="post-category">微信公众号</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp; 2022-01-22</div><div class="post-date info-break-policy"><i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp; 2022-02-10</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp; 25.8k</div><div class="info-break-policy"><i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp; 112 分</div><div id="busuanzi_container_page_pv" class="info-break-policy"><i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp; <span id="busuanzi_value_page_pv"></span></div></div></div><hr class="clearfix"><link rel="stylesheet" href="/liaojie.github.io/libs/prism/prism.css"><div class="card-content article-card-content"><div id="articleContent"><p>订阅号开发(服务号需要企业认证,不适合个人开发)</p><h2 id="1-注册微信公众号"><a href="#1-注册微信公众号" class="headerlink" title="1 注册微信公众号"></a>1 注册微信公众号</h2><p>1.注册网站</p><p>官网:<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/">https://mp.weixin.qq.com/</a></p><p>2.注册流程</p><p>1)打开官网,点击右上角的立即注册<br>2)选择订阅号注册<br>3)依次输入要求的信息,勾上我同意,点击注册<br>4)选择中国内地,点击确定<br>5)选择订阅号确定<br>6)主体类型选择个人,填写好信息点击继续<br>7)填写好信息点击完成</p><p>关键词回复:</p><ul><li>半匹配:只要包含关键字即可</li><li>全匹配:跟名字一样</li></ul><h2 id="开发者自行开发"><a href="#开发者自行开发" class="headerlink" title="开发者自行开发"></a>开发者自行开发</h2><h3 id="接口测试号"><a href="#接口测试号" class="headerlink" title="接口测试号"></a>接口测试号</h3><p>位置: 微信官方文档-&gt;开始开发-&gt;接口测试号申请</p><p><img src="/liaojie.github.io/medias/loading.gif" data-original="https://cdn.jsdelivr.net/gh/liaojie1314/PicGo/images/%E6%8E%A5%E5%8F%A3%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png"></p><p>打开WebStorm创建一个简单的服务器:</p><p>在工程文件夹下导包:<br><code>npm install express</code></p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入express模块</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token comment">//创建app应用对象</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//验证服务器的有效性</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//监听端口号</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器启动成功'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此时得到的是一个本地网址:<a href="http://localhost:3000,要将其转换为外部可访问网址才行">http://localhost:3000,要将其转换为外部可访问网址才行</a><br>工具:将内网映射成外网 <code>ngrok</code></p><p>指令: <code>ngrok http 3000</code><br>观察<code>Forwarding</code>后面即为外网网址</p><p>将网址加上<code>/html</code>输入在浏览器（例如: <a target="_blank" rel="noopener" href="http://xxx.ngrok.io/html">http://xxx.ngrok.io/html</a> ）<br>（注意:有的浏览器可能无法访问，换个浏览器就好）</p><p><img src="/liaojie.github.io/medias/loading.gif" data-original="https://cdn.jsdelivr.net/gh/liaojie1314/PicGo/images/ngrok.png"></p><p>有Gitub账号可直接登录，若没有账号可以先注册再登录</p><p><img src="/liaojie.github.io/medias/loading.gif" data-original="https://cdn.jsdelivr.net/gh/liaojie1314/PicGo/images/occount.png"></p><p>重新打开ngrok输入ngrok http 3000 –authtoken 加上上图authtoken后面的内容</p><p>（例如: ngrok http 3000 –authtoken 23RthpB7QpLdHrBTivoitz4CzZ8_4a9AcRX3ZuKKBXWfoPSYe）</p><p>将最终得到的网址填入URL栏,Token随便填写即可(尽量复杂)</p><p>填好之后在服务器上进行测试:</p><p>导入sha1库:<code>npm install sha1</code></p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入express模块</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入sha1模块</span>
<span class="token keyword">const</span> sha1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sha1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//创建app应用对象</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//验证服务器的有效性</span>
<span class="token comment">/*
1.微信服务器直到开发者服务器是哪个
- 测试号管理器上填写url开发者服务器地址
    -使用ngrok 内网穿透 将本地端口号开启的服务映射为外网可以访问的网址
    - ngrok http 3000
- Token
    - 参与微信签名加密的一个参数
2.开发者服务器 -验证消息是否来自微信服务器
    目的:计算得出signature微信加密签名,和微信传递过来的signature进项对比,如果一样说明消息来自于微信服务器,如果不一样说明表示不是微信服务器发送的消息
    1.将参与微信加密签名的三个参数(timestamp,nonce,token)组合在一起,按照字典序排序(0-9,a-z)形成一个数组
    2.将数组里所有参数拼接成一个字符串,进行sha1加密
    3.加密完成就生成了一个signature,和微信传递过来的signature进项对比,
    如果一样说明消息来自于微信服务器,返回echostr给微信服务器
    如果不一样说明表示不是微信服务器发送的消息,返回error
 */</span>
<span class="token comment">//定义配置对象</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    token<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    appID<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    appsecret<span class="token operator">:</span> <span class="token string">''</span>
<span class="token punctuation">}</span>
<span class="token comment">//接收处理所有参数</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//微信服务器提交的参数</span>
    <span class="token comment">//console.log(req.query);</span>
    <span class="token comment">/*
    {
  signature: '',    //微信的加密签名
  echostr: '',   //微信的随机字符串
  timestamp: '',  //微信发送请求的时间戳
  nonce: '' //微信的随机数字
}
     */</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span>signature<span class="token punctuation">,</span> echostr<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>token<span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>

<span class="token comment">//1.将参与微信加密签名的三个参数(timestamp,nonce,token)组合在一起,按照字典序排序(0-9,a-z)形成一个数组</span>

    <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span>timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> token<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> arrSort <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arrSort<span class="token punctuation">)</span>

<span class="token comment">//2.将数组里所有参数拼接成一个字符串,进行sha1加密</span>

    <span class="token keyword">const</span> str <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> sha1Str <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sha1Str<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//3.加密完成就生成了一个signature,和微信传递过来的signature进项对比,</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sha1Str <span class="token operator">===</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果一样说明消息来自于微信服务器,返回echostr给微信服务器</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>echostr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果不一样说明表示不是微信服务器发送的消息,返回error</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


<span class="token comment">//监听端口号</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器启动成功'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="模块化代码"><a href="#模块化代码" class="headerlink" title="模块化代码:"></a>模块化代码:</h3><p>新建config文件夹,在该文件夹下新建index.js文件</p><p>index.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//配置对象模块</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    token<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    appID<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    appsecret<span class="token operator">:</span> <span class="token string">''</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>新建wechat文件夹,在该文件下新建auth.js文件</p><p>auth.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入config模块</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../config"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入sha1模块</span>
<span class="token keyword">const</span> sha1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"sha1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
验证服务器有效性的模块
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//微信服务器提交的参数</span>
        <span class="token comment">//console.log(req.query);</span>
        <span class="token comment">/*
        {
      signature: '',    //微信的加密签名
      echostr: '',   //微信的随机字符串
      timestamp: '',  //微信发送请求的时间戳
      nonce: '' //微信的随机数字
    }
         */</span>

        <span class="token keyword">const</span> <span class="token punctuation">{</span>signature<span class="token punctuation">,</span> echostr<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span>token<span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>

<span class="token comment">//1.将参与微信加密签名的三个参数(timestamp,nonce,token)组合在一起,按照字典序排序(0-9,a-z)形成一个数组</span>

        <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span>timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> token<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> arrSort <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arrSort<span class="token punctuation">)</span>

<span class="token comment">//2.将数组里所有参数拼接成一个字符串,进行sha1加密</span>

        <span class="token keyword">const</span> str <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> sha1Str <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sha1Str<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//3.加密完成就生成了一个signature,和微信传递过来的signature进项对比,</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sha1Str <span class="token operator">===</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//如果一样说明消息来自于微信服务器,返回echostr给微信服务器</span>
            res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>echostr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//如果不一样说明表示不是微信服务器发送的消息,返回error</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>主文件</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入express模块</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入auto模块</span>
<span class="token keyword">const</span> auth <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./wechat/auth'</span><span class="token punctuation">)</span>
<span class="token comment">//创建app应用对象</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//接收处理所有参数</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//监听端口号</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器启动成功'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="获取access-token"><a href="#获取access-token" class="headerlink" title="获取access_token"></a>获取access_token</h3><p>位置: 微信官方文档-&gt;开始开发-&gt;获取access_token</p><p>access_token是公众号的全局唯一接口调用凭据，公众号调用各接口时都需使用access_token。开发者需要进行妥善保存。access_token的存储至少要保留512个字符空间。access_token的有效期目前为2个小时，需定时刷新，重复获取将导致上次获取的access_token失效。</p><p>公众平台的API调用所需的access_token的使用及生成方式说明：</p><p>1、建议公众号开发者使用中控服务器统一获取和刷新access_token，其他业务逻辑服务器所使用的access_token均来自于该中控服务器，不应该各自去刷新，否则容易造成冲突，导致access_token覆盖而影响业务；</p><p>2、目前access_token的有效期通过返回的expire_in来传达，目前是7200秒之内的值。中控服务器需要根据这个有效时间提前去刷新新access_token。在刷新过程中，中控服务器可对外继续输出的老access_token，此时公众平台后台会保证在5分钟内，新老access_token都可用，这保证了第三方业务的平滑过渡；</p><p>3、access_token的有效时间可能会在未来有调整，所以中控服务器不仅需要内部定时主动刷新，还需要提供被动刷新access_token的接口，这样便于业务服务器在API调用获知access_token已超时的情况下，可以触发access_token的刷新流程。</p><p>4、对于可能存在风险的调用，在开发者进行获取 access_token调用时进入风险调用确认流程，需要用户管理员确认后才可以成功获取。具体流程为：</p><p>开发者通过某IP发起调用-&gt;平台返回错误码[89503]并同时下发模板消息给公众号管理员-&gt;公众号管理员确认该IP可以调用-&gt;开发者使用该IP再次发起调用-&gt;调用成功。</p><p>如公众号管理员第一次拒绝该IP调用，用户在1个小时内将无法使用该IP再次发起调用，如公众号管理员多次拒绝该IP调用，该IP将可能长期无法发起调用。平台建议开发者在发起调用前主动与管理员沟通确认调用需求，或请求管理员开启IP白名单功能并将该IP加入IP白名单列表。</p><p>公众号和小程序均可以使用AppID和AppSecret调用本接口来获取access_token。AppID和AppSecret可在“微信公众平台-开发-基本配置”页中获得（需要已经成为开发者，且帐号没有异常状态）。<strong>调用接口时，请登录“微信公众平台-开发-基本配置”提前将服务器IP地址添加到IP白名单中，点击查看设置方法，否则将无法调用成功。</strong>小程序无需配置IP白名单。</p><p>接口调用请求说明</p><pre class="line-numbers language-none"><code class="language-none">https请求方式: GET https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>参数说明</p><table><thead><tr><th>参数</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>grant_type</td><td>是</td><td>获取access_token填写client_credential</td></tr><tr><td>appid</td><td>是</td><td>第三方用户唯一凭证</td></tr><tr><td>secret</td><td>是</td><td>第三方用户唯一凭证密钥，即appsecret</td></tr></tbody></table><p>返回说明</p><p>正常情况下，微信会返回下述JSON数据包给公众号：</p><blockquote><p>{“access_token”:”ACCESS_TOKEN”,”expires_in”:7200}</p></blockquote><p>参数说明</p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>access_token</td><td>获取到的凭证</td></tr><tr><td>expires_in</td><td>凭证有效时间，单位：秒</td></tr></tbody></table><p>错误时微信会返回错误码等信息，JSON数据包示例如下（该示例为AppID无效错误）:</p><blockquote><p>{“errcode”:40013,”errmsg”:”invalid appid”}</p></blockquote><p>返回码说明</p><table><thead><tr><th>返回码</th><th>说明</th></tr></thead><tbody><tr><td>-1</td><td>系统繁忙，此时请开发者稍候再试</td></tr><tr><td>0</td><td>请求成功</td></tr><tr><td>40001</td><td>AppSecret错误或者AppSecret不属于这个公众号，请开发者确认AppSecret的正确性</td></tr><tr><td>40002</td><td>请确保grant_type字段值为client_credential</td></tr><tr><td>40164</td><td>调用接口的IP地址不在白名单中，请在接口IP白名单中进行设置。</td></tr><tr><td>89503</td><td>此IP调用需要管理员确认,请联系管理员</td></tr><tr><td>89501</td><td>此IP正在等待管理员确认,请联系管理员</td></tr><tr><td>89506</td><td>24小时内该IP被管理员拒绝调用两次，24小时内不可再使用该IP调用</td></tr><tr><td>89507</td><td>1小时内该IP被管理员拒绝调用一次，1小时内不可再使用该IP调用</td></tr></tbody></table><p>在wechat文件夹下新建accessToken.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">/*
access_token：微信调用接口全局唯一凭证
特点:
    1.唯一
    2.有效期为2小时,提前5分钟重新请求
    3.接口权限 每天2000次
    https请求方式: GET https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET

    设计思路:
        1.首次本地没有,发送请求获取access_token,保存下来(本地文件)
        2.第二次或以后:
            - 先去本地读取文件,判断它是否过期
                - 过期了
                    - 重新请求,保存下来,覆盖之前的文件(保证文件是唯一的)
                - 没过期
                    - 直接使用

        整理思路:
            读取本地文件(readAccessToken):
                - 本地有文件
                    - 判断它是否过期(isValidAccessToken)
                        - 过期了
                           - 重新请求(getAccessToken),保存下来,覆盖之前的文件(保证文件是唯一的)(saveAccessToken)
                        - 没过期
                           - 直接使用
                - 本地没有文件
                    - 发送请求获取access_token(getAccessToken),保存下来(本地文件)(saveAccessToken)
 */</span>
<span class="token comment">//只需要引入request-promise-native库</span>
<span class="token keyword">const</span> rp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'request-promise-native'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//引入fs模块</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>writeFile<span class="token punctuation">,</span> readFile<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//引入config文件</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>appID<span class="token punctuation">,</span> appsecret<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//定义一个类,获取access_token</span>
<span class="token keyword">class</span> <span class="token class-name">Wechat</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
    用来获取access_token
     */</span>
    <span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//定义请求的地址</span>
        <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid='</span> <span class="token operator">+</span> appID <span class="token operator">+</span> <span class="token string">'&amp;secret='</span> <span class="token operator">+</span> appsecret<span class="token punctuation">;</span>
        <span class="token comment">//发送请求</span>
        <span class="token comment">/*
        需要下载俩个库
        request
        request-promise-native 返回值是一个promise对象
         */</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">rp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> json<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">/*
                    {
                      access_token: '53_ASJAH4U8r3yuEZFT4NCdzgLcBZN-W0rPy-0sBU0bizFlnxrXJ8rl8VxCZqllW8A_MZTTYr3eNnQN8GX-TUv4vuB-YuHde5BLlNN38fK-pb0ZujB7yE-5XwkX5NBX7bEA-yY7v2V2Wu8W-G
    SASVHcAFAKNZ',
                      expires_in: 7200
    }
                     */</span>
                    <span class="token comment">//设置access_token的过期时间 单位毫秒</span>
                    res<span class="token punctuation">.</span>expires_in <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>expires_in <span class="token operator">-</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
                    <span class="token comment">//将promise的对象的状态改为成功的状态</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'getAccessToken方法出了问题:'</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来保存access_token的方法
     * @param accessToken 要保存的凭据
     */</span>
    <span class="token function">saveAccessToken</span><span class="token punctuation">(</span><span class="token parameter">accessToken</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//将对象转化为json字符串</span>
        accessToken <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'./accessToken.txt'</span><span class="token punctuation">,</span> accessToken<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'文件保存成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'saveAccessToken方法出了问题:'</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来读取access_token的方法
     */</span>
    <span class="token function">readAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//读取本地文件中的access_taken</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./accessToken.txt'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'文件读取成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//将json字符串转化成js对象</span>
                    data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'readAccessToken方法出了问题:'</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来检查access_token是否有效
     * @param data
     */</span>
    <span class="token function">isValidAccessToken</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//检查传入的参数是否有效</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>access_token <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>expires_in<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//代表access_token无效</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//检查传入的参数是否在有效期内</span>
        <span class="token comment">// if (data.expires_in&lt;Date.now()){</span>
        <span class="token comment">//     //过期了</span>
        <span class="token comment">//     return false;</span>
        <span class="token comment">// }else {</span>
        <span class="token comment">//     //没有过期</span>
        <span class="token comment">//     return true;</span>
        <span class="token comment">// }</span>

        <span class="token keyword">return</span> data<span class="token punctuation">.</span>expires_in <span class="token operator">&gt;</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来获取没有过期的access_token
     * @returns {Promise&lt;unknown&gt;} access_token
     */</span>
    <span class="token function">fetchAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//优化</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>access_token <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>expires_in <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isValidAccessToken</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//说明之前保存过access_token,并且access_token有效,直接使用</span>
            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                access_token<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>access_token<span class="token punctuation">,</span>
                expires_in<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>expires_in
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">readAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">//本地有文件</span>
                <span class="token comment">//判断它是否过期(isValidAccessToken)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isValidAccessToken</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//有效的</span>
                    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//resolve(res);</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">//过期了</span>
                    <span class="token comment">//发送请求获取access_token(getAccessToken)</span>
                    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//保存下来(本地文件)(saveAccessToken)</span>
                    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveAccessToken</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//将请求回来的access_token返回出去</span>
                    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// resolve(res);</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">//本地没有文件</span>
                <span class="token comment">//发送请求获取access_token(getAccessToken)</span>
                <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//保存下来(本地文件)(saveAccessToken)</span>
                <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveAccessToken</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//将请求回来的access_token返回出去</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// resolve(res);</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">//将access_token挂载到this上</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>access_token <span class="token operator">=</span> res<span class="token punctuation">.</span>access_token<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>expires_in <span class="token operator">=</span> res<span class="token punctuation">.</span>expires_in<span class="token punctuation">;</span>
                <span class="token comment">//返回res包装了一层promise对象(此对象为成功的对象)</span>
                <span class="token comment">//是this.readAccessToken()最终返回值</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//模拟测试</span>
<span class="token keyword">const</span> w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wechat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
  读取本地文件(readAccessToken):
       - 本地有文件
           - 判断它是否过期(isValidAccessToken)
               - 过期了
                  - 重新请求(getAccessToken),保存下来,覆盖之前的文件(保证文件是唯一的)(saveAccessToken)
               - 没过期
                  - 直接使用
       - 本地没有文件
           - 发送请求获取access_token(getAccessToken),保存下来(本地文件)(saveAccessToken)
 */</span>
w<span class="token punctuation">.</span><span class="token function">fetchAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="获取用户发送的消息"><a href="#获取用户发送的消息" class="headerlink" title="获取用户发送的消息"></a>获取用户发送的消息</h3><p>扫描测试号二维码关注测试公众号,发送一条消息进行测试</p><p>auto.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入config模块</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../config"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入sha1模块</span>
<span class="token keyword">const</span> sha1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"sha1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
验证服务器有效性的模块
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//微信服务器提交的参数</span>
        <span class="token comment">//console.log(req.query);</span>

        <span class="token keyword">const</span> <span class="token punctuation">{</span>signature<span class="token punctuation">,</span> echostr<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span>token<span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>
        <span class="token comment">/*
            //1.将参与微信加密签名的三个参数(timestamp,nonce,token)组合在一起,按照字典序排序(0-9,a-z)形成一个数组

                const arr = [timestamp, nonce, token];
                const arrSort = arr.sort();
                console.log(arrSort)

            //2.将数组里所有参数拼接成一个字符串,进行sha1加密

                const str = arr.join('');
                console.log(str);
                const sha1Str = sha1(str);
                console.log(sha1Str);
         */</span>

        <span class="token comment">//简写</span>
        <span class="token keyword">const</span> sha1str <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token punctuation">[</span>timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> token<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
        微信服务器会发送俩种类型的消息给开发者
        1.GET请求
            - 验证服务器的有效性
        2.POST请求
            - 微信服务器会将用户发送的数据以POST请求的方式转发到开发者服务器
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//3.加密完成就生成了一个signature,和微信传递过来的signature进项对比,</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>sha1Str <span class="token operator">===</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//如果一样说明消息来自于微信服务器,返回echostr给微信服务器</span>
                res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>echostr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//如果不一样说明表示不是微信服务器发送的消息,返回error</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//微信服务器会将用户发送的数据以POST请求的方式转发到开发者服务器</span>
            <span class="token comment">//验证消息来自于微信服务器</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sha1str <span class="token operator">!==</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//说明消息不是微信服务器的</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/*

            {
            signature: '',
            timestamp: '',
            nonce: '',
            openid: '' //用户的微信ID
             }
             */</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行app.js得到如下信息:</p><pre class="line-numbers language-none"><code class="language-none">{
 signature: '',
 timestamp: '',
 nonce: '',
 openid: '' //用户的微信ID
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果开发者服务器没有返回响应给微信服务器,微信服务器会发送三次请求过来<br>在if中最后加上<code>res.end('');</code>即可</p><p>在项目下新建<code>utils</code>工具包文件夹,在里面新建一个文件<code>tool.js</code></p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">/*
工具函数包
 */</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">getUserDataAsync</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> xmlData <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
            req
                <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">//当流式数据传递过来时会触发当前事件,会将数据注入到回调函数中</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//读取的数据是buffer,需要将其转化为字符串</span>
                    xmlData <span class="token operator">+=</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">//当数据接收完毕时,会触发当前</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>auth.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入config模块</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../config"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入sha1模块</span>
<span class="token keyword">const</span> sha1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"sha1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入tool模块</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>getUserDataAsync<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils/tool'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
验证服务器有效性的模块
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//微信服务器提交的参数</span>
        <span class="token comment">//console.log(req.query);</span>

        <span class="token keyword">const</span> <span class="token punctuation">{</span>signature<span class="token punctuation">,</span> echostr<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span>token<span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>
        <span class="token keyword">const</span> sha1str <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token punctuation">[</span>timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> token<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
        微信服务器会发送俩种类型的消息给开发者
        1.GET请求
            - 验证服务器的有效性
        2.POST请求
            - 微信服务器会将用户发送的数据以POST请求的方式转发到开发者服务器
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//3.加密完成就生成了一个signature,和微信传递过来的signature进项对比,</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>sha1Str <span class="token operator">===</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//如果一样说明消息来自于微信服务器,返回echostr给微信服务器</span>
                res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>echostr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//如果不一样说明表示不是微信服务器发送的消息,返回error</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//微信服务器会将用户发送的数据以POST请求的方式转发到开发者服务器</span>
            <span class="token comment">//验证消息来自于微信服务器</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sha1str <span class="token operator">!==</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//说明消息不是微信服务器的</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// console.log(req.query);</span>
            <span class="token comment">//接收请求体中的数据,流式数据</span>

            <span class="token keyword">const</span> xmlData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUserDataAsync</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//如果开发者服务器没有返回响应给微信服务器,微信服务器会发送三次请求过来</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行app.js得到如下信息:</p><pre class="line-numbers language-none"><code class="language-none">&lt;xml&gt;&lt;ToUserName&gt;&lt;![CDATA[gh_3b6b3cd4d8e8]]&gt;&lt;/ToUserName&gt; //开发中id           
&lt;FromUserName&gt;&lt;![CDATA[okzHZ6Xb1dMfGx1fti6VV4en0aTU]]&gt;&lt;/FromUserName&gt;//用户 openid
&lt;CreateTime&gt;1643090286&lt;/CreateTime&gt;//发送的时间戳
&lt;MsgType&gt;&lt;![CDATA[text]]&gt;&lt;/MsgType&gt;//发送消息类型                      
&lt;Content&gt;&lt;![CDATA[123]]&gt;&lt;/Content&gt;//内容                      
&lt;MsgId&gt;23523394398679914&lt;/MsgId&gt;//消息id 微信服务器会默认保存3天用户发送的数据,通过次id三天内就可以找到此消息数据                                     
&lt;/xml&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来我们要得到xml中的数据</p><p>tool.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">/*
工具函数包
 */</span>
<span class="token comment">//npm install xml2js 导包</span>
<span class="token comment">//引入xml2js,将xml数据转化为js对象</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>parseString<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xml2js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">getUserDataAsync</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> xmlData <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
            req
                <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">//当流式数据传递过来时会触发当前事件,会将数据注入到回调函数中</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//读取的数据是buffer,需要将其转化为字符串</span>
                    xmlData <span class="token operator">+=</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">//当数据接收完毕时,会触发当前</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">parseXMLAsync</span><span class="token punctuation">(</span><span class="token parameter">xmlData</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">parseString</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">,</span><span class="token punctuation">{</span>trim<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'parseXMLAsync方法出了问题:'</span><span class="token operator">+</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>auth.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入config模块</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../config"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入sha1模块</span>
<span class="token keyword">const</span> sha1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"sha1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入tool模块</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>getUserDataAsync<span class="token punctuation">,</span>parseXMLAsync<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils/tool'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
验证服务器有效性的模块
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//微信服务器提交的参数</span>
        <span class="token comment">//console.log(req.query);</span>

        <span class="token keyword">const</span> <span class="token punctuation">{</span>signature<span class="token punctuation">,</span> echostr<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span>token<span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>
        <span class="token keyword">const</span> sha1str <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token punctuation">[</span>timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> token<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
        微信服务器会发送俩种类型的消息给开发者
        1.GET请求
            - 验证服务器的有效性
        2.POST请求
            - 微信服务器会将用户发送的数据以POST请求的方式转发到开发者服务器
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//3.加密完成就生成了一个signature,和微信传递过来的signature进项对比,</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>sha1Str <span class="token operator">===</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//如果一样说明消息来自于微信服务器,返回echostr给微信服务器</span>
                res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>echostr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//如果不一样说明表示不是微信服务器发送的消息,返回error</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//微信服务器会将用户发送的数据以POST请求的方式转发到开发者服务器</span>
            <span class="token comment">//验证消息来自于微信服务器</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sha1str <span class="token operator">!==</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//说明消息不是微信服务器的</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// console.log(req.query);</span>
            <span class="token comment">//接收请求体中的数据,流式数据</span>

            <span class="token keyword">const</span> xmlData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUserDataAsync</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将xml数据解析为js对象</span>
            <span class="token keyword">const</span> jsData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">parseXMLAsync</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>jsData<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//如果开发者服务器没有返回响应给微信服务器,微信服务器会发送三次请求过来</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行app.js得到如下信息:</p><pre class="line-numbers language-none"><code class="language-none">{
  xml: {
    ToUserName: [ 'gh_3b6b3cd4d8e8' ],
    FromUserName: [ 'okzHZ6Xb1dMfGx1fti6VV4en0aTU' ],
    CreateTime: [ '1643091294' ],
    MsgType: [ 'text' ],
    Content: [ '111' ],
    MsgId: [ '23523410572447438' ]
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>格式化得到的数据:</p><p>tool.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">/*
工具函数包
 */</span>
<span class="token comment">//npm install xml2js 导包</span>
<span class="token comment">//引入xml2js,将xml数据转化为js对象</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>parseString<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xml2js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">getUserDataAsync</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> xmlData <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
            req
                <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">//当流式数据传递过来时会触发当前事件,会将数据注入到回调函数中</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//读取的数据是buffer,需要将其转化为字符串</span>
                    xmlData <span class="token operator">+=</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">//当数据接收完毕时,会触发当前</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">parseXMLAsync</span><span class="token punctuation">(</span><span class="token parameter">xmlData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">parseString</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">,</span> <span class="token punctuation">{</span>trim<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'parseXMLAsync方法出了问题:'</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">formatMessage</span><span class="token punctuation">(</span><span class="token parameter">jsData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">//获取xml对象</span>
        jsData <span class="token operator">=</span> jsData<span class="token punctuation">.</span>xml<span class="token punctuation">;</span>
        <span class="token comment">//判断数据是否为一个对象</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> jsData <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//遍历对象</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> jsData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//获取属性值</span>
                <span class="token keyword">let</span> value <span class="token operator">=</span> jsData<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token comment">//过滤空数据</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//将合法数据赋值到message对象上</span>
                    message<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> message<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>auth.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入config模块</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../config"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入sha1模块</span>
<span class="token keyword">const</span> sha1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"sha1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入tool模块</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>getUserDataAsync<span class="token punctuation">,</span>parseXMLAsync<span class="token punctuation">,</span>formatMessage<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils/tool'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
验证服务器有效性的模块
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//微信服务器提交的参数</span>
        <span class="token comment">//console.log(req.query);</span>

        <span class="token keyword">const</span> <span class="token punctuation">{</span>signature<span class="token punctuation">,</span> echostr<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span>token<span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>
        <span class="token keyword">const</span> sha1str <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token punctuation">[</span>timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> token<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
        微信服务器会发送俩种类型的消息给开发者
        1.GET请求
            - 验证服务器的有效性
        2.POST请求
            - 微信服务器会将用户发送的数据以POST请求的方式转发到开发者服务器
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//3.加密完成就生成了一个signature,和微信传递过来的signature进项对比,</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>sha1Str <span class="token operator">===</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//如果一样说明消息来自于微信服务器,返回echostr给微信服务器</span>
                res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>echostr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//如果不一样说明表示不是微信服务器发送的消息,返回error</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//微信服务器会将用户发送的数据以POST请求的方式转发到开发者服务器</span>
            <span class="token comment">//验证消息来自于微信服务器</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sha1str <span class="token operator">!==</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//说明消息不是微信服务器的</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// console.log(req.query);</span>
            <span class="token comment">//接收请求体中的数据,流式数据</span>

            <span class="token keyword">const</span> xmlData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUserDataAsync</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将xml数据解析为js对象</span>
            <span class="token keyword">const</span> jsData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">parseXMLAsync</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>jsData<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//格式化数据</span>
            <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token function">formatMessage</span><span class="token punctuation">(</span>jsData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果开发者服务器没有返回响应给微信服务器,微信服务器会发送三次请求过来</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行app.js得到如下信息:</p><pre class="line-numbers language-none"><code class="language-none">{ CreateTime: '1643092243', MsgId: '23523424720943421' }<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="简单的自动回复"><a href="#简单的自动回复" class="headerlink" title="简单的自动回复"></a>简单的自动回复</h3><p>微信官方文档-&gt;基础消息能力-&gt;被动回复用户消息</p><p>当用户发送消息给公众号时（或某些特定的用户操作引发的事件推送时），会产生一个POST请求，开发者可以在响应包（Get）中返回特定XML结构，来对该消息进行响应（现支持回复文本、图片、图文、语音、视频、音乐）。严格来说，发送被动响应消息其实并不是一种接口，而是对微信服务器发过来消息的一次回复。</p><p>微信服务器在将用户的消息发给公众号的开发者服务器地址（开发者中心处配置）后，微信服务器在五秒内收不到响应会断掉连接，并且重新发起请求，总共重试三次，如果在调试中，发现用户无法收到响应的消息，可以检查是否消息处理超时。关于重试的消息排重，有msgid的消息推荐使用msgid排重。事件类型消息推荐使用FromUserName + CreateTime 排重。</p><p>如果开发者希望增强安全性，可以在开发者中心处开启消息加密，这样，用户发给公众号的消息以及公众号被动回复用户消息都会继续加密，详见被动回复消息加解密说明。</p><p>假如服务器无法保证在五秒内处理并回复，必须做出下述回复，这样微信服务器才不会对此作任何处理，并且不会发起重试（这种情况下，可以使用客服消息接口进行异步回复），否则，将出现严重的错误提示。详见下面说明：</p><p>1、直接回复success（推荐方式） 2、直接回复空串（指字节长度为0的空字符串，而不是XML结构体中content字段的内容为空）</p><p>一旦遇到以下情况，微信都会在公众号会话中，向用户下发系统提示“该公众号暂时无法提供服务，请稍后再试”：</p><p>1、开发者在5秒内未回复任何内容 2、开发者回复了异常数据，比如JSON数据等</p><p>另外，请注意，回复图片（不支持gif动图）等多媒体消息时需要预先通过素材管理接口上传临时素材到微信服务器，可以使用素材管理中的临时素材，也可以使用永久素材。</p><p>各消息类型需要的XML数据包结构如下：</p><h5 id="回复文本消息"><a href="#回复文本消息" class="headerlink" title="回复文本消息"></a>回复文本消息</h5><pre class="line-numbers language-none"><code class="language-none">&lt;xml&gt;
  &lt;ToUserName&gt;&lt;![CDATA[toUser]]&gt;&lt;/ToUserName&gt;
  &lt;FromUserName&gt;&lt;![CDATA[fromUser]]&gt;&lt;/FromUserName&gt;
  &lt;CreateTime&gt;12345678&lt;/CreateTime&gt;
  &lt;MsgType&gt;&lt;![CDATA[text]]&gt;&lt;/MsgType&gt;
  &lt;Content&gt;&lt;![CDATA[你好]]&gt;&lt;/Content&gt;
&lt;/xml&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>参数</th><th>是否必须</th><th>描述</th></tr></thead><tbody><tr><td>ToUserName</td><td>是</td><td>接收方帐号（收到的OpenID）</td></tr><tr><td>FromUserName</td><td>是</td><td>开发者微信号</td></tr><tr><td>CreateTime</td><td>是</td><td>消息创建时间 （整型）</td></tr><tr><td>MsgType</td><td>是</td><td>消息类型，文本为text</td></tr><tr><td>Content</td><td>是</td><td>回复的消息内容（换行：在content中能够换行，微信客户端就支持换行显示）</td></tr></tbody></table><h5 id="回复图片消息"><a href="#回复图片消息" class="headerlink" title="回复图片消息"></a>回复图片消息</h5><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[toUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[fromUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">&gt;</span></span>12345678<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[image]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Image</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MediaId</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[media_id]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MediaId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Image</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>参数</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>ToUserName</td><td>是</td><td>接收方帐号（收到的OpenID）</td></tr><tr><td>FromUserName</td><td>是</td><td>开发者微信号</td></tr><tr><td>CreateTime</td><td>是</td><td>消息创建时间 （整型）</td></tr><tr><td>MsgType</td><td>是</td><td>消息类型，图片为image</td></tr><tr><td>MediaId</td><td>是</td><td>通过素材管理中的接口上传多媒体文件，得到的id。</td></tr></tbody></table><h5 id="回复语音消息"><a href="#回复语音消息" class="headerlink" title="回复语音消息"></a>回复语音消息</h5><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[toUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[fromUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">&gt;</span></span>12345678<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[voice]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Voice</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MediaId</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[media_id]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MediaId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Voice</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>参数</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>ToUserName</td><td>是</td><td>接收方帐号（收到的OpenID）</td></tr><tr><td>FromUserName</td><td>是</td><td>开发者微信号</td></tr><tr><td>CreateTime</td><td>是</td><td>消息创建时间戳 （整型）</td></tr><tr><td>MsgType</td><td>是</td><td>消息类型，语音为voice</td></tr><tr><td>MediaId</td><td>是</td><td>通过素材管理中的接口上传多媒体文件，得到的id</td></tr></tbody></table><h5 id="回复视频消息"><a href="#回复视频消息" class="headerlink" title="回复视频消息"></a>回复视频消息</h5><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[toUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[fromUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">&gt;</span></span>12345678<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[video]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Video</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MediaId</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[media_id]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MediaId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Title</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[title]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Description</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[description]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Description</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Video</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>参数</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>ToUserName</td><td>是</td><td>接收方帐号（收到的OpenID）</td></tr><tr><td>FromUserName</td><td>是</td><td>开发者微信号</td></tr><tr><td>CreateTime</td><td>是</td><td>消息创建时间 （整型）</td></tr><tr><td>MsgType</td><td>是</td><td>消息类型，视频为video</td></tr><tr><td>MediaId</td><td>是</td><td>通过素材管理中的接口上传多媒体文件，得到的id</td></tr><tr><td>Title</td><td>否</td><td>视频消息的标题</td></tr><tr><td>Description</td><td>否</td><td>视频消息的描述</td></tr></tbody></table><h5 id="回复音乐消息"><a href="#回复音乐消息" class="headerlink" title="回复音乐消息"></a>回复音乐消息</h5><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[toUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[fromUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">&gt;</span></span>12345678<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[music]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Music</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Title</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[TITLE]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Description</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[DESCRIPTION]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Description</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MusicUrl</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[MUSIC_Url]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MusicUrl</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HQMusicUrl</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[HQ_MUSIC_Url]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>HQMusicUrl</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThumbMediaId</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[media_id]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ThumbMediaId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Music</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>参数</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>ToUserName</td><td>是</td><td>接收方帐号（收到的OpenID）</td></tr><tr><td>FromUserName</td><td>是</td><td>开发者微信号</td></tr><tr><td>CreateTime</td><td>是</td><td>消息创建时间 （整型）</td></tr><tr><td>MsgType</td><td>是</td><td>消息类型，音乐为music</td></tr><tr><td>Title</td><td>否</td><td>音乐标题</td></tr><tr><td>Description</td><td>否</td><td>音乐描述</td></tr><tr><td>MusicURL</td><td>否</td><td>音乐链接</td></tr><tr><td>HQMusicUrl</td><td>否</td><td>高质量音乐链接，WIFI环境优先使用该链接播放音乐</td></tr><tr><td>ThumbMediaId</td><td>是</td><td>缩略图的媒体id，通过素材管理中的接口上传多媒体文件，得到的id</td></tr></tbody></table><h5 id="回复图文消息"><a href="#回复图文消息" class="headerlink" title="回复图文消息"></a>回复图文消息</h5><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[toUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[fromUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">&gt;</span></span>12345678<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[news]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ArticleCount</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ArticleCount</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Articles</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Title</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[title1]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Title</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Description</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[description1]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Description</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PicUrl</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[picurl]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PicUrl</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Url</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[url]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Url</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>item</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Articles</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>参数</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>ToUserName</td><td>是</td><td>接收方帐号（收到的OpenID）</td></tr><tr><td>FromUserName</td><td>是</td><td>开发者微信号</td></tr><tr><td>CreateTime</td><td>是</td><td>消息创建时间 （整型）</td></tr><tr><td>MsgType</td><td>是</td><td>消息类型，图文为news</td></tr><tr><td>ArticleCount</td><td>是</td><td>图文消息个数；当用户发送文本、图片、语音、视频、图文、地理位置这六种消息时，开发者只能回复1条图文消息；其余场景最多可回复8条图文消息</td></tr><tr><td>Articles</td><td>是</td><td>图文消息信息，注意，如果图文数超过限制，则将只发限制内的条数</td></tr><tr><td>Title</td><td>是</td><td>图文消息标题</td></tr><tr><td>Description</td><td>是</td><td>图文消息描述</td></tr><tr><td>PicUrl</td><td>是</td><td>图片链接，支持JPG、PNG格式，较好的效果为大图360 * 200，小图200 * 200</td></tr><tr><td>Url</td><td>是</td><td>点击图文消息跳转链接</td></tr></tbody></table><p>auth.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入config模块</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../config"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入sha1模块</span>
<span class="token keyword">const</span> sha1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"sha1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入tool模块</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>getUserDataAsync<span class="token punctuation">,</span> parseXMLAsync<span class="token punctuation">,</span> formatMessage<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils/tool'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
验证服务器有效性的模块
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//微信服务器提交的参数</span>
        <span class="token comment">//console.log(req.query);</span>

        <span class="token keyword">const</span> <span class="token punctuation">{</span>signature<span class="token punctuation">,</span> echostr<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span>token<span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>
        <span class="token keyword">const</span> sha1str <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token punctuation">[</span>timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> token<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
        微信服务器会发送俩种类型的消息给开发者
        1.GET请求
            - 验证服务器的有效性
        2.POST请求
            - 微信服务器会将用户发送的数据以POST请求的方式转发到开发者服务器
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//3.加密完成就生成了一个signature,和微信传递过来的signature进项对比,</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>sha1Str <span class="token operator">===</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//如果一样说明消息来自于微信服务器,返回echostr给微信服务器</span>
                res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>echostr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//如果不一样说明表示不是微信服务器发送的消息,返回error</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//微信服务器会将用户发送的数据以POST请求的方式转发到开发者服务器</span>
            <span class="token comment">//验证消息来自于微信服务器</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sha1str <span class="token operator">!==</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//说明消息不是微信服务器的</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// console.log(req.query);</span>
            <span class="token comment">//接收请求体中的数据,流式数据</span>

            <span class="token keyword">const</span> xmlData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUserDataAsync</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// console.log(xmlData);</span>
            <span class="token comment">//将xml数据解析为js对象</span>
            <span class="token keyword">const</span> jsData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">parseXMLAsync</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// console.log(jsData);</span>
            <span class="token comment">//格式化数据</span>
            <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token function">formatMessage</span><span class="token punctuation">(</span>jsData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// console.log(message);</span>
            <span class="token comment">// console.log(message.Content)</span>
            <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token string">'你在说什么?'</span><span class="token punctuation">;</span>
            <span class="token comment">//判断用户发送的消息是不是文本消息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>MsgType<span class="token operator">===</span><span class="token string">'text'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//判断用户发送的内容具体是什么</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Content<span class="token operator">===</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//全匹配</span>
                    content<span class="token operator">=</span><span class="token string">'你好!!'</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Content<span class="token operator">===</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    content<span class="token operator">=</span><span class="token string">'hello~~'</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'爱'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//半匹配</span>
                    content<span class="token operator">=</span><span class="token string">'我爱你'</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//最终回复用户的消息</span>
            <span class="token keyword">let</span> replyMessage <span class="token operator">=</span> <span class="token string">'&lt;xml&gt;&lt;ToUserName&gt;&lt;![CDATA['</span><span class="token operator">+</span>message<span class="token punctuation">.</span>FromUserName<span class="token operator">+</span><span class="token string">']]&gt;&lt;/ToUserName&gt;&lt;FromUserName&gt;&lt;![CDATA['</span><span class="token operator">+</span>message<span class="token punctuation">.</span>ToUserName<span class="token operator">+</span><span class="token string">']]&gt;&lt;/FromUserName&gt;&lt;CreateTime&gt;'</span><span class="token operator">+</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'&lt;/CreateTime&gt;&lt;MsgType&gt;&lt;![CDATA[text]]&gt;&lt;/MsgType&gt;&lt;Content&gt;&lt;![CDATA['</span><span class="token operator">+</span>content<span class="token operator">+</span><span class="token string">']]&gt;&lt;/Content&gt;&lt;/xml&gt;'</span><span class="token punctuation">;</span>

            <span class="token comment">//返回响应给微信服务器</span>
            res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>replyMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//如果开发者服务器没有返回响应给微信服务器,微信服务器会发送三次请求过来</span>
            <span class="token comment">// res.end('');</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行app.js即可测试公众号</p><h3 id="定义回复用户消息的模块文件"><a href="#定义回复用户消息的模块文件" class="headerlink" title="定义回复用户消息的模块文件"></a>定义回复用户消息的模块文件</h3><h4 id="接收普通消息"><a href="#接收普通消息" class="headerlink" title="接收普通消息"></a>接收普通消息</h4><p>当普通微信用户向公众账号发消息时，微信服务器将POST消息的XML数据包到开发者填写的URL上。</p><p>请注意：</p><blockquote><p>关于重试的消息排重，推荐使用msgid排重。<br>微信服务器在五秒内收不到响应会断掉连接，并且重新发起请求，总共重试三次。假如服务器无法保证在五秒内处理并回复，可以直接回复空串，微信服务器不会对此作任何处理，并且不会发起重试。详情请见“发送消息-被动回复消息”。<br>如果开发者需要对用户消息在5秒内立即做出回应，即使用“发送消息-被动回复消息”接口向用户被动回复消息时，可以在</p></blockquote><p>公众平台官网的开发者中心处设置消息加密。开启加密后，用户发来的消息和开发者回复的消息都会被加密（但开发者通过客服接口等API调用形式向用户发送消息，则不受影响）。关于消息加解密的详细说明，请见“发送消息-被动回复消息加解密说明”。 各消息类型的推送XML数据包结构如下：</p><h5 id="文本消息"><a href="#文本消息" class="headerlink" title="文本消息"></a>文本消息</h5><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[toUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[fromUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">&gt;</span></span>1348831860<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[text]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Content</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[this is a test]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Content</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgId</span><span class="token punctuation">&gt;</span></span>1234567890123456<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>ToUserName</td><td>开发者微信号</td></tr><tr><td>FromUserName</td><td>发送方帐号（一个OpenID）</td></tr><tr><td>CreateTime</td><td>消息创建时间 （整型）</td></tr><tr><td>MsgType</td><td>消息类型，文本为text</td></tr><tr><td>Content</td><td>文本消息内容</td></tr><tr><td>MsgId</td><td>消息id，64位整型</td></tr></tbody></table><h5 id="图片消息"><a href="#图片消息" class="headerlink" title="图片消息"></a>图片消息</h5><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[toUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[fromUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">&gt;</span></span>1348831860<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[image]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PicUrl</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[this is a url]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PicUrl</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MediaId</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[media_id]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MediaId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgId</span><span class="token punctuation">&gt;</span></span>1234567890123456<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>ToUserName</td><td>开发者微信号</td></tr><tr><td>FromUserName</td><td>发送方帐号（一个OpenID）</td></tr><tr><td>CreateTime</td><td>消息创建时间 （整型）</td></tr><tr><td>MsgType</td><td>消息类型，图片为image</td></tr><tr><td>PicUrl</td><td>图片链接（由系统生成）</td></tr><tr><td>MediaId</td><td>图片消息媒体id，可以调用获取临时素材接口拉取数据。</td></tr><tr><td>MsgId</td><td>消息id，64位整型</td></tr></tbody></table><h5 id="语音消息"><a href="#语音消息" class="headerlink" title="语音消息"></a>语音消息</h5><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[toUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[fromUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">&gt;</span></span>1357290913<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[voice]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MediaId</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[media_id]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MediaId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Format</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[Format]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Format</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgId</span><span class="token punctuation">&gt;</span></span>1234567890123456<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>ToUserName</td><td>开发者微信号</td></tr><tr><td>FromUserName</td><td>发送方帐号（一个OpenID）</td></tr><tr><td>CreateTime</td><td>消息创建时间 （整型）</td></tr><tr><td>MsgType</td><td>语音为voice</td></tr><tr><td>MediaId</td><td>语音消息媒体id，可以调用获取临时素材接口拉取数据。</td></tr><tr><td>Format</td><td>语音格式，如amr，speex等</td></tr><tr><td>MsgId</td><td>消息id，64位整型</td></tr></tbody></table><p>请注意，开通语音识别后，用户每次发送语音给公众号时，微信会在推送的语音消息XML数据包中，增加一个Recognition字段（注：由于客户端缓存，开发者开启或者关闭语音识别功能，对新关注者立刻生效，对已关注用户需要24小时生效。开发者可以重新关注此帐号进行测试）。开启语音识别后的语音XML数据包如下：</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[toUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[fromUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">&gt;</span></span>1357290913<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[voice]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MediaId</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[media_id]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MediaId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Format</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[Format]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Format</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Recognition</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[腾讯微信团队]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Recognition</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgId</span><span class="token punctuation">&gt;</span></span>1234567890123456<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数说明：</p><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>ToUserName</td><td>开发者微信号</td></tr><tr><td>FromUserName</td><td>发送方帐号（一个OpenID）</td></tr><tr><td>CreateTime</td><td>消息创建时间 （整型）</td></tr><tr><td>MsgType</td><td>语音为voice</td></tr><tr><td>MediaId</td><td>语音消息媒体id，可以调用获取临时素材接口拉取该媒体</td></tr><tr><td>Format</td><td>语音格式：amr</td></tr><tr><td>Recognition</td><td>语音识别结果，UTF8编码</td></tr><tr><td>MsgId</td><td>消息id，64位整型</td></tr></tbody></table><h5 id="视频消息"><a href="#视频消息" class="headerlink" title="视频消息"></a>视频消息</h5><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[toUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[fromUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">&gt;</span></span>1357290913<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[video]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MediaId</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[media_id]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MediaId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThumbMediaId</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[thumb_media_id]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ThumbMediaId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgId</span><span class="token punctuation">&gt;</span></span>1234567890123456<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>ToUserName</td><td>开发者微信号</td></tr><tr><td>FromUserName</td><td>发送方帐号（一个OpenID）</td></tr><tr><td>CreateTime</td><td>消息创建时间 （整型）</td></tr><tr><td>MsgType</td><td>视频为video</td></tr><tr><td>MediaId</td><td>视频消息媒体id，可以调用获取临时素材接口拉取数据。</td></tr><tr><td>ThumbMediaId</td><td>视频消息缩略图的媒体id，可以调用多媒体文件下载接口拉取数据。</td></tr><tr><td>MsgId</td><td>消息id，64位整型</td></tr></tbody></table><h5 id="小视频消息"><a href="#小视频消息" class="headerlink" title="小视频消息"></a>小视频消息</h5><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[toUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[fromUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">&gt;</span></span>1357290913<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[shortvideo]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MediaId</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[media_id]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MediaId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThumbMediaId</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[thumb_media_id]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ThumbMediaId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgId</span><span class="token punctuation">&gt;</span></span>1234567890123456<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>ToUserName</td><td>开发者微信号</td></tr><tr><td>FromUserName</td><td>发送方帐号（一个OpenID）</td></tr><tr><td>CreateTime</td><td>消息创建时间 （整型）</td></tr><tr><td>MsgType</td><td>小视频为shortvideo</td></tr><tr><td>MediaId</td><td>视频消息媒体id，可以调用获取临时素材接口拉取数据。</td></tr><tr><td>ThumbMediaId</td><td>视频消息缩略图的媒体id，可以调用获取临时素材接口拉取数据。</td></tr><tr><td>MsgId</td><td>消息id，64位整型</td></tr></tbody></table><h5 id="地理位置消息"><a href="#地理位置消息" class="headerlink" title="地理位置消息"></a>地理位置消息</h5><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[toUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[fromUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">&gt;</span></span>1351776360<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[location]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Location_X</span><span class="token punctuation">&gt;</span></span>23.134521<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Location_X</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Location_Y</span><span class="token punctuation">&gt;</span></span>113.358803<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Location_Y</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Scale</span><span class="token punctuation">&gt;</span></span>20<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Scale</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Label</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[位置信息]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Label</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgId</span><span class="token punctuation">&gt;</span></span>1234567890123456<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>ToUserName</td><td>开发者微信号</td></tr><tr><td>FromUserName</td><td>发送方帐号（一个OpenID）</td></tr><tr><td>CreateTime</td><td>消息创建时间 （整型）</td></tr><tr><td>MsgType</td><td>消息类型，地理位置为location</td></tr><tr><td>Location_X</td><td>地理位置纬度</td></tr><tr><td>Location_Y</td><td>地理位置经度</td></tr><tr><td>Scale</td><td>地图缩放大小</td></tr><tr><td>Label</td><td>地理位置信息</td></tr><tr><td>MsgId</td><td>消息id，64位整型</td></tr></tbody></table><h5 id="链接消息"><a href="#链接消息" class="headerlink" title="链接消息"></a>链接消息</h5><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[toUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[fromUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">&gt;</span></span>1351776360<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[link]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Title</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[公众平台官网链接]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Description</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[公众平台官网链接]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Description</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Url</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[url]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Url</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgId</span><span class="token punctuation">&gt;</span></span>1234567890123456<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>ToUserName</td><td>接收方微信号</td></tr><tr><td>FromUserName</td><td>发送方微信号，若为普通用户，则是一个OpenID</td></tr><tr><td>CreateTime</td><td>消息创建时间</td></tr><tr><td>MsgType</td><td>消息类型，链接为link</td></tr><tr><td>Title</td><td>消息标题</td></tr><tr><td>Description</td><td>消息描述</td></tr><tr><td>Url</td><td>消息链接</td></tr><tr><td>MsgId</td><td>消息id，64位整型</td></tr></tbody></table><h4 id="接收事件推送"><a href="#接收事件推送" class="headerlink" title="接收事件推送"></a>接收事件推送</h4><p>在微信用户和公众号产生交互的过程中，用户的某些操作会使得微信服务器通过事件推送的形式通知到开发者在开发者中心处设置的服务器地址，从而开发者可以获取到该信息。其中，某些事件推送在发生后，是允许开发者回复用户的，某些则不允许，详细内容如下：</p><h5 id="关注-取消关注事件"><a href="#关注-取消关注事件" class="headerlink" title="关注/取消关注事件"></a>关注/取消关注事件</h5><p>用户在关注与取消关注公众号时，微信会把这个事件推送到开发者填写的URL。方便开发者给用户下发欢迎消息或者做帐号的解绑。为保护用户数据隐私，开发者收到用户取消关注事件时需要删除该用户的所有信息。</p><p>微信服务器在五秒内收不到响应会断掉连接，并且重新发起请求，总共重试三次。</p><p>关于重试的消息排重，推荐使用FromUserName + CreateTime 排重。</p><p>假如服务器无法保证在五秒内处理并回复，可以直接回复空串，微信服务器不会对此作任何处理，并且不会发起重试。</p><p>推送XML数据包示例：</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[toUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[FromUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">&gt;</span></span>123456789<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[event]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Event</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[subscribe]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Event</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数说明：</p><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>ToUserName</td><td>开发者微信号</td></tr><tr><td>FromUserName</td><td>发送方帐号（一个OpenID）</td></tr><tr><td>CreateTime</td><td>消息创建时间 （整型）</td></tr><tr><td>MsgType</td><td>消息类型，event</td></tr><tr><td>Event</td><td>事件类型，subscribe(订阅)、unsubscribe(取消订阅)</td></tr></tbody></table><h5 id="扫描带参数二维码事件"><a href="#扫描带参数二维码事件" class="headerlink" title="扫描带参数二维码事件"></a>扫描带参数二维码事件</h5><p>用户扫描带场景值二维码时，可能推送以下两种事件：</p><blockquote><p>如果用户还未关注公众号，则用户可以关注公众号，关注后微信会将带场景值关注事件推送给开发者。<br>如果用户已经关注公众号，则微信会将带场景值扫描事件推送给开发者。</p></blockquote><ol><li>用户未关注时，进行关注后的事件推送</li></ol><p>推送XML数据包示例：</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[toUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[FromUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">&gt;</span></span>123456789<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[event]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Event</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[subscribe]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Event</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EventKey</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[qrscene_123123]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EventKey</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Ticket</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[TICKET]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Ticket</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数说明：</p><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>ToUserName</td><td>开发者微信号</td></tr><tr><td>FromUserName</td><td>发送方帐号（一个OpenID）</td></tr><tr><td>CreateTime</td><td>消息创建时间 （整型）</td></tr><tr><td>MsgType</td><td>消息类型，event</td></tr><tr><td>Event</td><td>事件类型，subscribe</td></tr><tr><td>EventKey</td><td>事件KEY值，qrscene_为前缀，后面为二维码的参数值</td></tr><tr><td>Ticket</td><td>二维码的ticket，可用来换取二维码图片</td></tr></tbody></table><ol start="2"><li>用户已关注时的事件推送</li></ol><p>推送XML数据包示例：</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[toUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[FromUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">&gt;</span></span>123456789<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[event]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Event</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[SCAN]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Event</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EventKey</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[SCENE_VALUE]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EventKey</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Ticket</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[TICKET]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Ticket</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数说明：</p><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>ToUserName</td><td>开发者微信号</td></tr><tr><td>FromUserName</td><td>发送方帐号（一个OpenID）</td></tr><tr><td>CreateTime</td><td>消息创建时间 （整型）</td></tr><tr><td>MsgType</td><td>消息类型，event</td></tr><tr><td>Event</td><td>事件类型，SCAN</td></tr><tr><td>EventKey</td><td>事件KEY值，是一个32位无符号整数，即创建二维码时的二维码scene_id</td></tr><tr><td>Ticket</td><td>二维码的ticket，可用来换取二维码图片</td></tr></tbody></table><h5 id="上报地理位置事件"><a href="#上报地理位置事件" class="headerlink" title="上报地理位置事件"></a>上报地理位置事件</h5><p>用户同意上报地理位置后，每次进入公众号会话时，都会在进入时上报地理位置，或在进入会话后每5秒上报一次地理位置，公众号可以在公众平台网站中修改以上设置。上报地理位置时，微信会将上报地理位置事件推送到开发者填写的URL。</p><p>推送XML数据包示例：</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[toUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[fromUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">&gt;</span></span>123456789<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[event]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Event</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[LOCATION]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Event</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Latitude</span><span class="token punctuation">&gt;</span></span>23.137466<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Latitude</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Longitude</span><span class="token punctuation">&gt;</span></span>113.352425<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Longitude</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Precision</span><span class="token punctuation">&gt;</span></span>119.385040<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Precision</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数说明：</p><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>ToUserName</td><td>开发者微信号</td></tr><tr><td>FromUserName</td><td>发送方帐号（一个OpenID）</td></tr><tr><td>CreateTime</td><td>消息创建时间 （整型）</td></tr><tr><td>MsgType</td><td>消息类型，event</td></tr><tr><td>Event</td><td>事件类型，LOCATION</td></tr><tr><td>Latitude</td><td>地理位置纬度</td></tr><tr><td>Longitude</td><td>地理位置经度</td></tr><tr><td>Precision</td><td>地理位置精度</td></tr></tbody></table><h5 id="自定义菜单事件"><a href="#自定义菜单事件" class="headerlink" title="自定义菜单事件"></a>自定义菜单事件</h5><p>用户点击自定义菜单后，微信会把点击事件推送给开发者，请注意，点击菜单弹出子菜单，不会产生上报。</p><p>点击菜单拉取消息时的事件推送</p><p>推送XML数据包示例：</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[toUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[FromUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">&gt;</span></span>123456789<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[event]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Event</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[CLICK]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Event</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EventKey</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[EVENTKEY]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EventKey</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数说明：</p><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>ToUserName</td><td>开发者微信号</td></tr><tr><td>FromUserName</td><td>发送方帐号（一个OpenID）</td></tr><tr><td>CreateTime</td><td>消息创建时间 （整型）</td></tr><tr><td>MsgType</td><td>消息类型，event</td></tr><tr><td>Event</td><td>事件类型，CLICK</td></tr><tr><td>EventKey</td><td>事件KEY值，与自定义菜单接口中KEY值对应</td></tr></tbody></table><p>点击菜单跳转链接时的事件推送</p><p>推送XML数据包示例：</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[toUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[FromUser]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">&gt;</span></span>123456789<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[event]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Event</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[VIEW]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Event</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EventKey</span><span class="token punctuation">&gt;</span></span><span class="token cdata">&lt;![CDATA[www.qq.com]]&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>EventKey</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数说明：</p><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>ToUserName</td><td>开发者微信号</td></tr><tr><td>FromUserName</td><td>发送方帐号（一个OpenID）</td></tr><tr><td>CreateTime</td><td>消息创建时间 （整型）</td></tr><tr><td>MsgType</td><td>消息类型，event</td></tr><tr><td>Event</td><td>事件类型，VIEW</td></tr><tr><td>EventKey</td><td>事件KEY值，设置的跳转URL</td></tr></tbody></table><p>在wechat文件夹下新建template.js,reply.js文件</p><p>template.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">/*
加工处理最终回复用户消息的模板(xml数据)
mediaID:上传素材得到
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">options</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> replayMessage <span class="token operator">=</span> <span class="token string">'&lt;xml&gt;'</span> <span class="token operator">+</span>
        <span class="token string">'&lt;ToUserName&gt;&lt;![CDATA['</span> <span class="token operator">+</span> options<span class="token punctuation">.</span>toUserName <span class="token operator">+</span> <span class="token string">']]&gt;&lt;/ToUserName&gt;'</span> <span class="token operator">+</span>
        <span class="token string">'&lt;FromUserName&gt;&lt;![CDATA['</span> <span class="token operator">+</span> message<span class="token punctuation">.</span>fromUserName <span class="token operator">+</span> <span class="token string">']]&gt;&lt;/FromUserName&gt;'</span> <span class="token operator">+</span>
        <span class="token string">'&lt;CreateTime&gt;'</span> <span class="token operator">+</span> options<span class="token punctuation">.</span>createTime <span class="token operator">+</span> <span class="token string">'&lt;/CreateTime&gt;'</span> <span class="token operator">+</span>
        <span class="token string">'&lt;MsgType&gt;&lt;![CDATA['</span> <span class="token operator">+</span> options<span class="token punctuation">.</span>msgType <span class="token operator">+</span> <span class="token string">']]&gt;&lt;/MsgType&gt;'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>msgType <span class="token operator">===</span> <span class="token string">'text'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        replyMessage <span class="token operator">+=</span> <span class="token string">'&lt;Content&gt;&lt;![CDATA['</span> <span class="token operator">+</span> options<span class="token punctuation">.</span>content <span class="token operator">+</span> <span class="token string">']]&gt;&lt;/Content&gt;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>msgType <span class="token operator">===</span> <span class="token string">'image'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        replyMessage <span class="token operator">+=</span> <span class="token string">'&lt;Image&gt;&lt;MediaId&gt;&lt;![CDATA['</span> <span class="token operator">+</span> options<span class="token punctuation">.</span>mediaID <span class="token operator">+</span> <span class="token string">']]&gt;&lt;/MediaId&gt;&lt;/Image&gt;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>msgType <span class="token operator">===</span> <span class="token string">'voice'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        replyMessage <span class="token operator">+=</span> <span class="token string">'&lt;Voice&gt;&lt;MediaId&gt;&lt;![CDATA['</span> <span class="token operator">+</span> options<span class="token punctuation">.</span>mediaID <span class="token operator">+</span> <span class="token string">']]&gt;&lt;/MediaId&gt;&lt;/Voice&gt;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>msgType <span class="token operator">===</span> <span class="token string">'video'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        replyMessage <span class="token operator">+=</span> <span class="token string">'&lt;Video&gt;'</span> <span class="token operator">+</span>
            <span class="token string">'&lt;MediaId&gt;&lt;![CDATA['</span> <span class="token operator">+</span> options<span class="token punctuation">.</span>mediaID <span class="token operator">+</span> <span class="token string">']]&gt;&lt;/MediaId&gt;'</span> <span class="token operator">+</span>
            <span class="token string">'&lt;Title&gt;&lt;![CDATA['</span> <span class="token operator">+</span> options<span class="token punctuation">.</span>title <span class="token operator">+</span> <span class="token string">']]&gt;&lt;/Title&gt;'</span> <span class="token operator">+</span>
            <span class="token string">'&lt;Description&gt;&lt;![CDATA['</span> <span class="token operator">+</span> options<span class="token punctuation">.</span>description <span class="token operator">+</span> <span class="token string">']]&gt;&lt;/Description&gt;'</span> <span class="token operator">+</span>
            <span class="token string">'&lt;/Video&gt;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>msgType <span class="token operator">===</span> <span class="token string">'music'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        replyMessage <span class="token operator">+=</span> <span class="token string">'&lt;Music&gt;'</span> <span class="token operator">+</span>
            <span class="token string">'&lt;Title&gt;&lt;![CDATA['</span> <span class="token operator">+</span> options<span class="token punctuation">.</span>title <span class="token operator">+</span> <span class="token string">']]&gt;&lt;/Title&gt;'</span> <span class="token operator">+</span>
            <span class="token string">'&lt;Description&gt;&lt;![CDATA['</span> <span class="token operator">+</span> options<span class="token punctuation">.</span>description <span class="token operator">+</span> <span class="token string">']]&gt;&lt;/Description&gt;'</span> <span class="token operator">+</span>
            <span class="token string">'&lt;MusicUrl&gt;&lt;![CDATA['</span> <span class="token operator">+</span> options<span class="token punctuation">.</span>musicUrl <span class="token operator">+</span> <span class="token string">']]&gt;&lt;/MusicUrl&gt;'</span> <span class="token operator">+</span>
            <span class="token string">'&lt;HQMusicUrl&gt;&lt;![CDATA['</span> <span class="token operator">+</span> options<span class="token punctuation">.</span>hpMusicUrl <span class="token operator">+</span> <span class="token string">']]&gt;&lt;/HQMusicUrl&gt;'</span> <span class="token operator">+</span>
            <span class="token string">'&lt;ThumbMediaId&gt;&lt;![CDATA['</span> <span class="token operator">+</span> options<span class="token punctuation">.</span>mediaID <span class="token operator">+</span> <span class="token string">']]&gt;&lt;/ThumbMediaId&gt;'</span> <span class="token operator">+</span>
            <span class="token string">'&lt;/Music&gt;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>msgType <span class="token operator">===</span> <span class="token string">'news'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        replyMessage <span class="token operator">+=</span> <span class="token string">'&lt;ArticleCount&gt;'</span> <span class="token operator">+</span> options<span class="token punctuation">.</span>content<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">'&lt;/ArticleCount&gt;'</span> <span class="token operator">+</span>
            <span class="token string">'&lt;Articles&gt;'</span><span class="token punctuation">;</span>

        options<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            replyMessage <span class="token operator">+=</span> <span class="token string">'&lt;item&gt;'</span> <span class="token operator">+</span>
                <span class="token string">'&lt;Title&gt;&lt;![CDATA['</span> <span class="token operator">+</span> item<span class="token punctuation">.</span>title <span class="token operator">+</span> <span class="token string">']]&gt;&lt;/Title&gt;'</span> <span class="token operator">+</span>
                <span class="token string">'&lt;Description&gt;&lt;![CDATA['</span> <span class="token operator">+</span> item<span class="token punctuation">.</span>description <span class="token operator">+</span> <span class="token string">']]&gt;&lt;/Description&gt;'</span> <span class="token operator">+</span>
                <span class="token string">'&lt;PicUrl&gt;&lt;![CDATA['</span> <span class="token operator">+</span> item<span class="token punctuation">.</span>picUrl <span class="token operator">+</span> <span class="token string">']]&gt;&lt;/PicUrl&gt;'</span> <span class="token operator">+</span>
                <span class="token string">'&lt;Url&gt;&lt;![CDATA['</span> <span class="token operator">+</span> item<span class="token punctuation">.</span>url <span class="token operator">+</span> <span class="token string">']]&gt;&lt;/Url&gt;'</span> <span class="token operator">+</span>
                <span class="token string">'&lt;/item&gt;'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        replayMessage <span class="token operator">+=</span> <span class="token string">'&lt;/Articles&gt;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    replayMessage <span class="token operator">+=</span> <span class="token string">'&lt;/xml&gt;'</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> replayMessage<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>reply.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">/*
处理用户发送的消息的类型和内容,决定返回不同的内容给用户
 */</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">message</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
        toUserName<span class="token operator">:</span> message<span class="token punctuation">.</span>FromUserName<span class="token punctuation">,</span>
        fromUserName<span class="token operator">:</span> message<span class="token punctuation">.</span>ToUserName<span class="token punctuation">,</span>
        createTime<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        magType<span class="token operator">:</span> <span class="token string">'text'</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token string">'你在说什么?'</span><span class="token punctuation">;</span>
    <span class="token comment">//判断用户发送的消息是不是文本消息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>MsgType <span class="token operator">===</span> <span class="token string">'text'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//判断用户发送的内容具体是什么</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Content <span class="token operator">===</span> <span class="token string">'1'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//全匹配</span>
            content <span class="token operator">=</span> <span class="token string">'你好!!'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Content <span class="token operator">===</span> <span class="token string">'2'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            content <span class="token operator">=</span> <span class="token string">'hello~~'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'爱'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//半匹配</span>
            content <span class="token operator">=</span> <span class="token string">'我爱你'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>MsgType <span class="token operator">===</span> <span class="token string">'image'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>msgType <span class="token operator">=</span> <span class="token string">'image'</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>mediaID <span class="token operator">=</span> message<span class="token punctuation">.</span>MediaId<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>PicUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>MsgType <span class="token operator">===</span> <span class="token string">'voice'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span>msgType <span class="token operator">=</span> <span class="token string">'voice'</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>mediaID <span class="token operator">=</span> message<span class="token punctuation">.</span>MediaId<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>Recognition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>MsgType <span class="token operator">===</span> <span class="token string">'location'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        content <span class="token operator">=</span> <span class="token string">'维度:'</span> <span class="token operator">+</span> message<span class="token punctuation">.</span>Location_X <span class="token operator">+</span> <span class="token string">' 经度:'</span> <span class="token operator">+</span> message<span class="token punctuation">.</span>Location_Y <span class="token operator">+</span> <span class="token string">' 缩放大小:'</span> <span class="token operator">+</span> message<span class="token punctuation">.</span>Scale
            <span class="token operator">+</span> <span class="token string">' 位置信息:'</span> <span class="token operator">+</span> message<span class="token punctuation">.</span>Label<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>PicUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>MsgType <span class="token operator">===</span> <span class="token string">'event'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Event <span class="token operator">===</span> <span class="token string">'subscribe'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//用户订阅事件</span>
            content <span class="token operator">=</span> <span class="token string">"感谢您的订阅"</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>EventKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                content <span class="token operator">=</span> <span class="token string">'用户扫描了带参数的二维码关注事件'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Event <span class="token operator">===</span> <span class="token string">'unsubscribe'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'无情取关'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Event <span class="token operator">===</span> <span class="token string">'SCAN'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            content <span class="token operator">=</span> <span class="token string">'用户已经关注,再次扫描了带参数的二维码关注事件'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Event <span class="token operator">===</span> <span class="token string">'LOCATION'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            content <span class="token operator">=</span> <span class="token string">'维度:'</span> <span class="token operator">+</span> message<span class="token punctuation">.</span>Latitude <span class="token operator">+</span> <span class="token string">' 经度:'</span> <span class="token operator">+</span> message<span class="token punctuation">.</span>Longitude <span class="token operator">+</span> <span class="token string">' 精度:'</span> <span class="token operator">+</span> message<span class="token punctuation">.</span>Precision<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Event <span class="token operator">===</span> <span class="token string">'CLICK'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            content <span class="token operator">=</span> <span class="token string">'你点击了按钮:'</span> <span class="token operator">+</span> message<span class="token punctuation">.</span>EventKey<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    options<span class="token punctuation">.</span>content <span class="token operator">=</span> content<span class="token punctuation">;</span>

    <span class="token keyword">return</span> options<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>auth.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入config模块</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../config"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入template模块</span>
<span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./template"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入reply模块</span>
<span class="token keyword">const</span> reply <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./reply"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入sha1模块</span>
<span class="token keyword">const</span> sha1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"sha1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入tool模块</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>getUserDataAsync<span class="token punctuation">,</span> parseXMLAsync<span class="token punctuation">,</span> formatMessage<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils/tool'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
验证服务器有效性的模块
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//微信服务器提交的参数</span>
        <span class="token comment">//console.log(req.query);</span>

        <span class="token keyword">const</span> <span class="token punctuation">{</span>signature<span class="token punctuation">,</span> echostr<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span>token<span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>
        <span class="token keyword">const</span> sha1str <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token punctuation">[</span>timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> token<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
        微信服务器会发送俩种类型的消息给开发者
        1.GET请求
            - 验证服务器的有效性
        2.POST请求
            - 微信服务器会将用户发送的数据以POST请求的方式转发到开发者服务器
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//3.加密完成就生成了一个signature,和微信传递过来的signature进项对比,</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>sha1Str <span class="token operator">===</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//如果一样说明消息来自于微信服务器,返回echostr给微信服务器</span>
                res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>echostr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//如果不一样说明表示不是微信服务器发送的消息,返回error</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//微信服务器会将用户发送的数据以POST请求的方式转发到开发者服务器</span>
            <span class="token comment">//验证消息来自于微信服务器</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sha1str <span class="token operator">!==</span> signature<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//说明消息不是微信服务器的</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// console.log(req.query);</span>
            <span class="token comment">//接收请求体中的数据,流式数据</span>

            <span class="token keyword">const</span> xmlData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getUserDataAsync</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// console.log(xmlData);</span>
            <span class="token comment">//将xml数据解析为js对象</span>
            <span class="token keyword">const</span> jsData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">parseXMLAsync</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// console.log(jsData);</span>
            <span class="token comment">//格式化数据</span>
            <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token function">formatMessage</span><span class="token punctuation">(</span>jsData<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">const</span> options<span class="token operator">=</span><span class="token function">reply</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//最终回复用户的消息</span>
            <span class="token keyword">const</span> replyMessage <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//返回响应给微信服务器</span>
            res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>replyMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//如果开发者服务器没有返回响应给微信服务器,微信服务器会发送三次请求过来</span>
            <span class="token comment">// res.end('');</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意:接收语音识别结果、获取用户地理位置需在测试号管理界面开启</p><h3 id="实现自定义菜单"><a href="#实现自定义菜单" class="headerlink" title="实现自定义菜单"></a>实现自定义菜单</h3><h4 id="创建接口"><a href="#创建接口" class="headerlink" title="创建接口"></a>创建接口</h4><p>请注意：</p><blockquote><p>自定义菜单最多包括3个一级菜单，每个一级菜单最多包含5个二级菜单。<br>一级菜单最多4个汉字，二级菜单最多8个汉字，多出来的部分将会以“…”代替。<br>创建自定义菜单后，菜单的刷新策略是，在用户进入公众号会话页或公众号profile页时，如果发现上一次拉取菜单的请求在5分钟以前，就会拉取一下菜单，如果菜单有更新，就会刷新客户端的菜单。测试时可以尝试取消关注公众账号后再次关注，则可以看到创建后的效果。</p></blockquote><p>自定义菜单接口可实现多种类型按钮，如下：</p><blockquote><p>click：点击推事件用户点击click类型按钮后，微信服务器会通过消息接口推送消息类型为event的结构给开发者（参考消息接口指南），并且带上按钮中开发者填写的key值，开发者可以通过自定义的key值与用户进行交互；<br>view：跳转URL用户点击view类型按钮后，微信客户端将会打开开发者在按钮中填写的网页URL，可与网页授权获取用户基本信息接口结合，获得用户基本信息。<br>scancode_push：扫码推事件用户点击按钮后，微信客户端将调起扫一扫工具，完成扫码操作后显示扫描结果（如果是URL，将进入URL），且会将扫码的结果传给开发者，开发者可以下发消息。<br>scancode_waitmsg：扫码推事件且弹出“消息接收中”提示框用户点击按钮后，微信客户端将调起扫一扫工具，完成扫码操作后，将扫码的结果传给开发者，同时收起扫一扫工具，然后弹出“消息接收中”提示框，随后可能会收到开发者下发的消息。<br>pic_sysphoto：弹出系统拍照发图用户点击按钮后，微信客户端将调起系统相机，完成拍照操作后，会将拍摄的相片发送给开发者，并推送事件给开发者，同时收起系统相机，随后可能会收到开发者下发的消息。<br>pic_photo_or_album：弹出拍照或者相册发图用户点击按钮后，微信客户端将弹出选择器供用户选择“拍照”或者“从手机相册选择”。用户选择后即走其他两种流程。<br>pic_weixin：弹出微信相册发图器用户点击按钮后，微信客户端将调起微信相册，完成选择操作后，将选择的相片发送给开发者的服务器，并推送事件给开发者，同时收起相册，随后可能会收到开发者下发的消息。<br>location_select：弹出地理位置选择器用户点击按钮后，微信客户端将调起地理位置选择工具，完成选择操作后，将选择的地理位置发送给开发者的服务器，同时收起位置选择工具，随后可能会收到开发者下发的消息。<br>media_id：下发消息（除文本消息）用户点击media_id类型按钮后，微信服务器会将开发者填写的永久素材id对应的素材下发给用户，永久素材类型可以是图片、音频、视频 、图文消息。请注意：永久素材id必须是在“素材管理/新增永久素材”接口上传后获得的合法id。<br>view_limited：跳转图文消息URL用户点击view_limited类型按钮后，微信客户端将打开开发者在按钮中填写的永久素材id对应的图文消息URL，永久素材类型只支持图文消息。请注意：永久素材id必须是在“素材管理/新增永久素材”接口上传后获得的合法id。<br>article_id：用户点击 article_id 类型按钮后，微信客户端将会以卡片形式，下发开发者在按钮中填写的图文消息<br>article_view_limited：类似 view_limited，但不使用 media_id 而使用 article_id</p></blockquote><p>注意: 草稿接口灰度完成后，将不再支持图文信息类型的 media_id 和 view_limited，有需要的，请使用 article_id 和 article_view_limited 代替</p><p>请注意，3到8的所有事件，仅支持微信iPhone5.4.1以上版本，和Android5.4以上版本的微信用户，旧版本微信用户点击后将没有回应，开发者也不能正常接收到事件推送。9～12，是专门给第三方平台旗下未微信认证（具体而言，是资质认证未通过）的订阅号准备的事件类型，它们是没有事件推送的，能力相对受限，其他类型的公众号不必使用。</p><p>接口调用请求说明</p><p>http请求方式：POST（请使用https协议） <a target="_blank" rel="noopener" href="https://api.weixin.qq.com/cgi-bin/menu/create?access_token=ACCESS_TOKEN">https://api.weixin.qq.com/cgi-bin/menu/create?access_token=ACCESS_TOKEN</a></p><p>click和view的请求示例</p><pre class="line-numbers language-none"><code class="language-none">{
    "button":[
    {  
         "type":"click",
         "name":"今日歌曲",
         "key":"V1001_TODAY_MUSIC"
     },
     {
          "name":"菜单",
          "sub_button":[
          {    
              "type":"view",
              "name":"搜索",
              "url":"http://www.soso.com/"
           },
           {
                "type":"miniprogram",
                "name":"wxa",
                "url":"http://mp.weixin.qq.com",
                "appid":"wx286b93c14bbf93aa",
                "pagepath":"pages/lunar/index"
            },
           {
              "type":"click",
              "name":"赞一下我们",
              "key":"V1001_GOOD"
           }]
      }]
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其他新增按钮类型的请求示例</p><pre class="line-numbers language-none"><code class="language-none">{
    "button": [
        {
            "name": "扫码", 
            "sub_button": [
                {
                    "type": "scancode_waitmsg", 
                    "name": "扫码带提示", 
                    "key": "rselfmenu_0_0", 
                    "sub_button": [ ]
                }, 
                {
                    "type": "scancode_push", 
                    "name": "扫码推事件", 
                    "key": "rselfmenu_0_1", 
                    "sub_button": [ ]
                }
            ]
        }, 
        {
            "name": "发图", 
            "sub_button": [
                {
                    "type": "pic_sysphoto", 
                    "name": "系统拍照发图", 
                    "key": "rselfmenu_1_0", 
                   "sub_button": [ ]
                 }, 
                {
                    "type": "pic_photo_or_album", 
                    "name": "拍照或者相册发图", 
                    "key": "rselfmenu_1_1", 
                    "sub_button": [ ]
                }, 
                {
                    "type": "pic_weixin", 
                    "name": "微信相册发图", 
                    "key": "rselfmenu_1_2", 
                    "sub_button": [ ]
                }
            ]
        }, 
        {
            "name": "发送位置", 
            "type": "location_select", 
            "key": "rselfmenu_2_0"
        },
        {
           "type": "media_id", 
           "name": "图片", 
           "media_id": "MEDIA_ID1"
        }, 
        {
           "type": "view_limited", 
           "name": "图文消息", 
           "media_id": "MEDIA_ID2"
        },
        {
            "type": "article_id",
            "name": "发布后的图文消息",
            "article_id": "ARTICLE_ID1"
        },
        {
            "type": "article_view_limited",
            "name": "发布后的图文消息",
            "article_id": "ARTICLE_ID2"
        }
    ]
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参数说明</p><table><thead><tr><th>参数</th><th>是否必须</th><th>说明</th></tr></thead><tbody><tr><td>button</td><td>是</td><td>一级菜单数组，个数应为1~3个</td></tr><tr><td>sub_button</td><td>否</td><td>二级菜单数组，个数应为1~5个</td></tr><tr><td>type</td><td>是</td><td>菜单的响应动作类型，view表示网页类型，click表示点击类型，miniprogram表示小程序类型</td></tr><tr><td>name</td><td>是</td><td>菜单标题，不超过16个字节，子菜单不超过60个字节</td></tr><tr><td>key</td><td>click等点击类型必须</td><td>菜单KEY值，用于消息接口推送，不超过128字节</td></tr><tr><td>url</td><td>view、miniprogram类型必须</td><td>网页 链接，用户点击菜单可打开链接，不超过1024字节。 type为miniprogram时，不支持小程序的老版本客户端将打开本url。</td></tr><tr><td>media_id</td><td>media_id类型和view_limited类型必须</td><td>调用新增永久素材接口返回的合法media_id</td></tr><tr><td>appid</td><td>miniprogram类型必须</td><td>小程序的appid（仅认证公众号可配置）</td></tr><tr><td>pagepath</td><td>miniprogram类型必须</td><td>小程序的页面路径</td></tr><tr><td>article_id</td><td>article_id类型和article_view_limited类型必须</td><td>发布后获得的合法 article_id</td></tr></tbody></table><p>返回结果</p><p>正确时的返回JSON数据包如下：</p><blockquote><p>{“errcode”:0,”errmsg”:”ok”}</p></blockquote><p>错误时的返回JSON数据包如下（示例为无效菜单名长度）：</p><blockquote><p>{“errcode”:40018,”errmsg”:”invalid button name size”}</p></blockquote><h4 id="删除接口"><a href="#删除接口" class="headerlink" title="删除接口"></a>删除接口</h4><p>使用接口创建自定义菜单后，开发者还可使用接口删除当前使用的自定义菜单。另请注意，在个性化菜单时，调用此接口会删除默认菜单及全部个性化菜单。</p><p>请求说明</p><p>http请求方式：GET <a target="_blank" rel="noopener" href="https://api.weixin.qq.com/cgi-bin/menu/delete?access_token=ACCESS_TOKEN">https://api.weixin.qq.com/cgi-bin/menu/delete?access_token=ACCESS_TOKEN</a></p><p>返回说明</p><p>对应创建接口，正确的Json返回结果:</p><blockquote><p>{“errcode”:0,”errmsg”:”ok”}</p></blockquote><p>代码:</p><p>在wechat文件夹下新建menu.js文件用来存储发送回去的数据:</p><p>menu.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">/*
自定义菜单
 */</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"button"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"click"</span><span class="token punctuation">,</span>
            <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"戳我呀~"</span><span class="token punctuation">,</span>
            <span class="token string">"key"</span><span class="token operator">:</span> <span class="token string">"CLICK"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"菜单二"</span><span class="token punctuation">,</span>
            <span class="token string">"sub_button"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"view"</span><span class="token punctuation">,</span>
                    <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"百度搜索"</span><span class="token punctuation">,</span>
                    <span class="token string">"url"</span><span class="token operator">:</span> <span class="token string">"http://www.baidu.com/"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"scancode_waitmsg"</span><span class="token punctuation">,</span>
                    <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"扫码带提示"</span><span class="token punctuation">,</span>
                    <span class="token string">"key"</span><span class="token operator">:</span> <span class="token string">"扫码带提示"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// {</span>
                <span class="token comment">//     "type": "scancode_push",</span>
                <span class="token comment">//     "name": "扫码推事件",</span>
                <span class="token comment">//     "key": "扫码推事件"</span>
                <span class="token comment">// },</span>
                <span class="token comment">// {</span>
                <span class="token comment">//     "type": "media_id",</span>
                <span class="token comment">//     "name": "点击按钮发送图片",</span>
                <span class="token comment">//     "media_id": "MEDIA_ID1"</span>
                <span class="token comment">// },</span>
                <span class="token comment">// {</span>
                <span class="token comment">//     "type": "view_limited",</span>
                <span class="token comment">//     "name": "图文消息",</span>
                <span class="token comment">//     "media_id": "MEDIA_ID2"</span>
                <span class="token comment">// }</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"发图"</span><span class="token punctuation">,</span>
            <span class="token string">"sub_button"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"pic_sysphoto"</span><span class="token punctuation">,</span>
                    <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"系统拍照发图"</span><span class="token punctuation">,</span>
                    <span class="token string">"key"</span><span class="token operator">:</span> <span class="token string">"系统拍照发图"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"pic_photo_or_album"</span><span class="token punctuation">,</span>
                    <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"拍照或者相册发图"</span><span class="token punctuation">,</span>
                    <span class="token string">"key"</span><span class="token operator">:</span> <span class="token string">"拍照或者相册发图"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"pic_weixin"</span><span class="token punctuation">,</span>
                    <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"微信相册发图"</span><span class="token punctuation">,</span>
                    <span class="token string">"key"</span><span class="token operator">:</span> <span class="token string">"微信相册发图"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"发送位置"</span><span class="token punctuation">,</span>
                    <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"location_select"</span><span class="token punctuation">,</span>
                    <span class="token string">"key"</span><span class="token operator">:</span> <span class="token string">"rselfmenu_2_0"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>因为创建菜单需要用到access_token值,所以我们在accessToken.js文件下增加俩个函数:创建菜单和删除菜单,并改名为wechat.js</p><p>wechat.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">/*
access_token：微信调用接口全局唯一凭证
特点:
    1.唯一
    2.有效期为2小时,提前5分钟重新请求
    3.接口权限 每天2000次
    https请求方式: GET https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET

    设计思路:
        1.首次本地没有,发送请求获取access_token,保存下来(本地文件)
        2.第二次或以后:
            - 先去本地读取文件,判断它是否过期
                - 过期了
                    - 重新请求,保存下来,覆盖之前的文件(保证文件是唯一的)
                - 没过期
                    - 直接使用

        整理思路:
            读取本地文件(readAccessToken):
                - 本地有文件
                    - 判断它是否过期(isValidAccessToken)
                        - 过期了
                           - 重新请求(getAccessToken),保存下来,覆盖之前的文件(保证文件是唯一的)(saveAccessToken)
                        - 没过期
                           - 直接使用
                - 本地没有文件
                    - 发送请求获取access_token(getAccessToken),保存下来(本地文件)(saveAccessToken)
 */</span>

<span class="token comment">//引入menu模块</span>
<span class="token keyword">const</span> menu<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./menu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//只需要引入request-promise-native库</span>
<span class="token keyword">const</span> rp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'request-promise-native'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//引入fs模块</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>writeFile<span class="token punctuation">,</span> readFile<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//引入config文件</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>appID<span class="token punctuation">,</span> appsecret<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//定义一个类,获取access_token</span>
<span class="token keyword">class</span> <span class="token class-name">Wechat</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
    用来获取access_token
     */</span>
    <span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//定义请求的地址</span>
        <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid='</span> <span class="token operator">+</span> appID <span class="token operator">+</span> <span class="token string">'&amp;secret='</span> <span class="token operator">+</span> appsecret<span class="token punctuation">;</span>
        <span class="token comment">//发送请求</span>
        <span class="token comment">/*
        需要下载俩个库
        request
        request-promise-native 返回值是一个promise对象
         */</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">rp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> json<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">/*
                    {
                      access_token: '',
                      expires_in: 
    }
                     */</span>
                    <span class="token comment">//设置access_token的过期时间 单位毫秒</span>
                    res<span class="token punctuation">.</span>expires_in <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>expires_in <span class="token operator">-</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
                    <span class="token comment">//将promise的对象的状态改为成功的状态</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'getAccessToken方法出了问题:'</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来保存access_token的方法
     * @param accessToken 要保存的凭据
     */</span>
    <span class="token function">saveAccessToken</span><span class="token punctuation">(</span><span class="token parameter">accessToken</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//将对象转化为json字符串</span>
        accessToken <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'./accessToken.txt'</span><span class="token punctuation">,</span> accessToken<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'文件保存成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'saveAccessToken方法出了问题:'</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来读取access_token的方法
     */</span>
    <span class="token function">readAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//读取本地文件中的access_taken</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./accessToken.txt'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'文件读取成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//将json字符串转化成js对象</span>
                    data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'readAccessToken方法出了问题:'</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来检查access_token是否有效
     * @param data
     */</span>
    <span class="token function">isValidAccessToken</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//检查传入的参数是否有效</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>access_token <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>expires_in<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//代表access_token无效</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//检查传入的参数是否在有效期内</span>
        <span class="token comment">// if (data.expires_in&lt;Date.now()){</span>
        <span class="token comment">//     //过期了</span>
        <span class="token comment">//     return false;</span>
        <span class="token comment">// }else {</span>
        <span class="token comment">//     //没有过期</span>
        <span class="token comment">//     return true;</span>
        <span class="token comment">// }</span>

        <span class="token keyword">return</span> data<span class="token punctuation">.</span>expires_in <span class="token operator">&gt;</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来获取没有过期的access_token
     * @returns {Promise&lt;unknown&gt;} access_token
     */</span>
    <span class="token function">fetchAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//优化</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>access_token <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>expires_in <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isValidAccessToken</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//说明之前保存过access_token,并且access_token有效,直接使用</span>
            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                access_token<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>access_token<span class="token punctuation">,</span>
                expires_in<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>expires_in
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">readAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">//本地有文件</span>
                <span class="token comment">//判断它是否过期(isValidAccessToken)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isValidAccessToken</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//有效的</span>
                    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//resolve(res);</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">//过期了</span>
                    <span class="token comment">//发送请求获取access_token(getAccessToken)</span>
                    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//保存下来(本地文件)(saveAccessToken)</span>
                    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveAccessToken</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//将请求回来的access_token返回出去</span>
                    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// resolve(res);</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">//本地没有文件</span>
                <span class="token comment">//发送请求获取access_token(getAccessToken)</span>
                <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//保存下来(本地文件)(saveAccessToken)</span>
                <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveAccessToken</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//将请求回来的access_token返回出去</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// resolve(res);</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">//将access_token挂载到this上</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>access_token <span class="token operator">=</span> res<span class="token punctuation">.</span>access_token<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>expires_in <span class="token operator">=</span> res<span class="token punctuation">.</span>expires_in<span class="token punctuation">;</span>
                <span class="token comment">//返回res包装了一层promise对象(此对象为成功的对象)</span>
                <span class="token comment">//是this.readAccessToken()最终返回值</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来创建自定义菜单
     * @param menu 菜单的对象
     * @returns {Promise&lt;unknown&gt;}
     */</span>
    <span class="token function">createMenu</span><span class="token punctuation">(</span><span class="token parameter">menu</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//获取access_token</span>
                <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//定义请求地址</span>
                <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.weixin.qq.com/cgi-bin/menu/create?access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                <span class="token comment">//发送请求</span>
                <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">rp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> json<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> body<span class="token operator">:</span> menu<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'createMenu方法出了问题:'</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来删除自定义菜单
     * @returns {Promise&lt;unknown&gt;}
     */</span>
    <span class="token function">deleteMenu</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//定义请求地址</span>
                <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">GET https://api.weixin.qq.com/cgi-bin/menu/delete?access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                <span class="token comment">//发送请求</span>
                <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">rp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> json<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span>
                <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'deleteMenu方法出了问题:'</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> w<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Wechat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//删除之前定义的菜单</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> w<span class="token punctuation">.</span><span class="token function">deleteMenu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建新的菜单</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> w<span class="token punctuation">.</span><span class="token function">createMenu</span><span class="token punctuation">(</span>menu<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行wechat.js得到如下结果:</p><blockquote><p>{ errcode: 0, errmsg: ‘ok’ }<br>{ errcode: 0, errmsg: ‘ok’ }</p></blockquote><h2 id="网页开发"><a href="#网页开发" class="headerlink" title="网页开发"></a>网页开发</h2><h3 id="获取ticket"><a href="#获取ticket" class="headerlink" title="获取ticket"></a>获取ticket</h3><p>自己写页面:<br>在项目下新建一个views文件夹,在里面新建search.ejs文件</p><p>search.ejs</p><pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>search<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>这是一个搜索页面<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后配置模板资源目录、配置模板引擎、渲染页面,将渲染好的页面通过<code>render</code>方法返回给用户<br>app.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入express模块</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入auto模块</span>
<span class="token keyword">const</span> auth <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./wechat/auth'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//创建app应用对象</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//配置模板资源目录</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'views'</span><span class="token punctuation">,</span><span class="token string">'./views'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//配置模板引擎</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'view engine'</span><span class="token punctuation">,</span><span class="token string">'ejs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//页面路由</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/search'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">//渲染页面,将渲染好的页面返回给用户</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'search'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//接收处理所有参数</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//监听端口号</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器启动成功'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行app.js,输入ngrok网址+<code>/search</code>得到如下结果:</p><p><img src="/liaojie.github.io/medias/loading.gif" data-original="https://cdn.jsdelivr.net/gh/liaojie1314/PicGo/images/search%E9%A1%B5%E9%9D%A2.png"></p><p>接下来我们使用微信给我们提供的工具:<code>JS-SDK</code></p><p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html">官方文档</a></p><p>首先我们需要获得ticket(获取方式与access_token大同小异)</p><p>在utils文件夹下新建api.js用来存放api接口:</p><p>api.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//地址前缀</span>

<span class="token keyword">const</span> prefix <span class="token operator">=</span> <span class="token string">'https://api.weixin.qq.com/cgi-bin/'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    accessToken<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">token?grant_type=client_credential</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    ticket<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ticket/getticket?type=jsapi</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    menu<span class="token operator">:</span> <span class="token punctuation">{</span>
        create<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">menu/create?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token keyword">delete</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">menu/delete?</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>tool.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">/*
工具函数包
 */</span>
<span class="token comment">//npm install xml2js 导包</span>
<span class="token comment">//引入xml2js,将xml数据转化为js对象</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>parseString<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xml2js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入fs模块</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>writeFile<span class="token punctuation">,</span> readFile<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入path模块</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>resolve<span class="token punctuation">}</span><span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">getUserDataAsync</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> xmlData <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
            req
                <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">//当流式数据传递过来时会触发当前事件,会将数据注入到回调函数中</span>
                    <span class="token comment">// console.log(data);</span>
                    <span class="token comment">//读取的数据是buffer,需要将其转化为字符串</span>
                    xmlData <span class="token operator">+=</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">//当数据接收完毕时,会触发当前</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">parseXMLAsync</span><span class="token punctuation">(</span><span class="token parameter">xmlData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">parseString</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">,</span> <span class="token punctuation">{</span>trim<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'parseXMLAsync方法出了问题:'</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">formatMessage</span><span class="token punctuation">(</span><span class="token parameter">jsData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">//获取xml对象</span>
        jsData <span class="token operator">=</span> jsData<span class="token punctuation">.</span>xml<span class="token punctuation">;</span>
        <span class="token comment">//判断数据是否为一个对象</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> jsData <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//遍历对象</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> jsData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//获取属性值</span>
                <span class="token keyword">let</span> value <span class="token operator">=</span> jsData<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token comment">//过滤空数据</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//将合法数据赋值到message对象上</span>
                    message<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> message<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">writeFileAsync</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> fileName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//将对象转化为json字符串</span>
        data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//使用绝对路径</span>
        <span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">writeFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'文件保存成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'writeFileAsync方法出了问题:'</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function">readFileAsync</span><span class="token punctuation">(</span><span class="token parameter">fileName</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">readFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'文件读取成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//将json字符串转化成js对象</span>
                    data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'readFileAsync方法出了问题:'</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>wechat.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入menu模块</span>
<span class="token keyword">const</span> menu<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./menu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//只需要引入request-promise-native库</span>
<span class="token keyword">const</span> rp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'request-promise-native'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入api模块</span>
<span class="token keyword">const</span> api<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils/api'</span><span class="token punctuation">)</span>
<span class="token comment">//引入工具函数</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>writeFileAsync<span class="token punctuation">,</span>readFileAsync<span class="token punctuation">}</span><span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils/tool'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入config文件</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>appID<span class="token punctuation">,</span> appsecret<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//定义一个类,获取access_token</span>
<span class="token keyword">class</span> <span class="token class-name">Wechat</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
    用来获取access_token
     */</span>
    <span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//定义请求的地址</span>
        <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>api<span class="token punctuation">.</span>accessToken<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;appid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appID<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;secret=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>appsecret<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token comment">//发送请求</span>
        <span class="token comment">/*
        需要下载俩个库
        request
        request-promise-native 返回值是一个promise对象
         */</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">rp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> json<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//设置access_token的过期时间 单位毫秒</span>
                    res<span class="token punctuation">.</span>expires_in <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>expires_in <span class="token operator">-</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
                    <span class="token comment">//将promise的对象的状态改为成功的状态</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'getAccessToken方法出了问题:'</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来保存access_token的方法
     * @param accessToken 要保存的凭据
     */</span>
    <span class="token function">saveAccessToken</span><span class="token punctuation">(</span><span class="token parameter">accessToken</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">writeFileAsync</span><span class="token punctuation">(</span>accessToken<span class="token punctuation">,</span><span class="token string">'access_token.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来读取access_token的方法
     */</span>
    <span class="token function">readAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">readFileAsync</span><span class="token punctuation">(</span><span class="token string">'access_token.txt'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来检查access_token是否有效
     * @param data
     */</span>
    <span class="token function">isValidAccessToken</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//检查传入的参数是否有效</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>access_token <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>expires_in<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//代表access_token无效</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> data<span class="token punctuation">.</span>expires_in <span class="token operator">&gt;</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来获取没有过期的access_token
     * @returns {Promise&lt;unknown&gt;} access_token
     */</span>
    <span class="token function">fetchAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//优化</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>access_token <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>expires_in <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isValidAccessToken</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//说明之前保存过access_token,并且access_token有效,直接使用</span>
            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                access_token<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>access_token<span class="token punctuation">,</span>
                expires_in<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>expires_in
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">readAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">//本地有文件</span>
                <span class="token comment">//判断它是否过期(isValidAccessToken)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isValidAccessToken</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//有效的</span>
                    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//resolve(res);</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">//过期了</span>
                    <span class="token comment">//发送请求获取access_token(getAccessToken)</span>
                    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//保存下来(本地文件)(saveAccessToken)</span>
                    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveAccessToken</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//将请求回来的access_token返回出去</span>
                    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// resolve(res);</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">//本地没有文件</span>
                <span class="token comment">//发送请求获取access_token(getAccessToken)</span>
                <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//保存下来(本地文件)(saveAccessToken)</span>
                <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveAccessToken</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//将请求回来的access_token返回出去</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// resolve(res);</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">//将access_token挂载到this上</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>access_token <span class="token operator">=</span> res<span class="token punctuation">.</span>access_token<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>expires_in <span class="token operator">=</span> res<span class="token punctuation">.</span>expires_in<span class="token punctuation">;</span>
                <span class="token comment">//返回res包装了一层promise对象(此对象为成功的对象)</span>
                <span class="token comment">//是this.readAccessToken()最终返回值</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
    用来获取jsapi_ticket
     */</span>
    <span class="token function">getTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//发送请求</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取access_token</span>
            <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//定义请求的地址</span>
            <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>api<span class="token punctuation">.</span>ticket<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token function">rp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> json<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">//将promise的对象的状态改为成功的状态</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        ticket<span class="token operator">:</span>res<span class="token punctuation">.</span>ticket<span class="token punctuation">,</span>
                        expires_in<span class="token operator">:</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>expires_in <span class="token operator">-</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'getTicket方法出了问题:'</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来保存jsapi_ticket的方法
     * @param ticket 要保存的票据
     */</span>
    <span class="token function">saveTicket</span><span class="token punctuation">(</span><span class="token parameter">ticket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">writeFileAsync</span><span class="token punctuation">(</span>ticket<span class="token punctuation">,</span><span class="token string">'ticket.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来读取ticket的方法
     */</span>
    <span class="token function">readTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">readFileAsync</span><span class="token punctuation">(</span><span class="token string">'ticket.txt'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来检查ticket是否有效
     * @param data
     */</span>
    <span class="token function">isValidTicket</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//检查传入的参数是否有效</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>ticket <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>expires_in<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//代表ticket无效</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> data<span class="token punctuation">.</span>expires_in <span class="token operator">&gt;</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来获取没有过期的ticket
     * @returns {Promise&lt;unknown&gt;} ticket
     */</span>
    <span class="token function">fetchTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//优化</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ticket <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ticket_expires_in <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isValidTicket</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//说明之前保存过ticket,并且ticket有效,直接使用</span>
            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                ticket<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ticket<span class="token punctuation">,</span>
                expires_in<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>expires_in
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">readTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">//本地有文件</span>
                <span class="token comment">//判断它是否过期(isValidTicket)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isValidTicket</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//有效的</span>
                    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">//过期了</span>
                    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//保存下来(本地文件)(saveTicket)</span>
                    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveTicket</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//将请求回来的access_token返回出去</span>
                    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">//本地没有文件</span>
                <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveTicket</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">//将ticket挂载到this上</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>ticket <span class="token operator">=</span> res<span class="token punctuation">.</span>ticket<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>ticket_expires_in <span class="token operator">=</span> res<span class="token punctuation">.</span>expires_in<span class="token punctuation">;</span>
                <span class="token comment">//返回res包装了一层promise对象(此对象为成功的对象)</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来创建自定义菜单
     * @param menu 菜单的对象
     * @returns {Promise&lt;unknown&gt;}
     */</span>
    <span class="token function">createMenu</span><span class="token punctuation">(</span><span class="token parameter">menu</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//获取access_token</span>
                <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//定义请求地址</span>
                <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>api<span class="token punctuation">.</span>menu<span class="token punctuation">.</span>create<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                <span class="token comment">//发送请求</span>
                <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">rp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> json<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> body<span class="token operator">:</span> menu<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'createMenu方法出了问题:'</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 用来删除自定义菜单
     * @returns {Promise&lt;unknown&gt;}
     */</span>
    <span class="token function">deleteMenu</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//定义请求地址</span>
                <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>api<span class="token punctuation">.</span>menu<span class="token punctuation">.</span>delete<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                <span class="token comment">//发送请求</span>
                <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">rp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> json<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'deleteMenu方法出了问题:'</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> w<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Wechat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*//删除之前定义的菜单
    let result = await w.deleteMenu();
    console.log(result);
    //创建新的菜单
    result = await w.createMenu(menu);
    console.log(result);*/</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> w<span class="token punctuation">.</span><span class="token function">fetchTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将Wechat暴露出去:在最后添加<code>module.exports = Wechat;</code>并把上面的测试代码注释掉<br>即:</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">/*(async ()=&gt;{
    const w=new Wechat();
    /!*!//删除之前定义的菜单
    let result = await w.deleteMenu();
    console.log(result);
    //创建新的菜单
    result = await w.createMenu(menu);
    console.log(result);*!/
    const data = await w.fetchTicket();
    console.log(data);
})()*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在config文件夹下的index.js中添加<code>url: 'ngrok地址'</code></p><p>app.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入express模块</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入sha1加密</span>
<span class="token keyword">const</span> sha1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sha1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入config文件</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>url<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入auto模块</span>
<span class="token keyword">const</span> auth <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./wechat/auth'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入wechat模块</span>
<span class="token keyword">const</span> Wechat <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./wechat/wechat'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//创建app应用对象</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//配置模板资源目录</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'views'</span><span class="token punctuation">,</span> <span class="token string">'./views'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//配置模板引擎</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'view engine'</span><span class="token punctuation">,</span> <span class="token string">'ejs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//创建实例对象</span>
<span class="token keyword">const</span> wechatApi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wechat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//页面路由</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/search'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//生成js-sdk需要使用的签名：</span>
    <span class="token comment">//随机字符串</span>
    <span class="token keyword">const</span> noncestr <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//时间戳</span>
    <span class="token keyword">const</span> timestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获取票据</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>ticket<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> wechatApi<span class="token punctuation">.</span><span class="token function">fetchTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//1.组合参与签名的4个参数:jsapi_ticket(临时票据),noncestr(随机字符串),timestamp(时间戳),url(当前服务器地址)</span>
    <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">jsapi_ticket=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ticket<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">noncestr=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noncestr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">timestamp=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">url=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/search</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">]</span>
    <span class="token comment">//2.将其进行字典连续,并以'&amp;'拼接在一起</span>
    <span class="token keyword">const</span> str <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//xxx=xxx&amp;xxx=xxx&amp;xxx=xxx</span>
    <span class="token comment">//3.进行sha1加密,最终生成想要的signature</span>
    <span class="token keyword">const</span> signature <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//渲染页面,将渲染好的页面返回给用户</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'search'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        signature<span class="token punctuation">,</span>
        noncestr<span class="token punctuation">,</span>
        timestamp
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//接收处理所有参数</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//监听端口号</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器启动成功'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改search.ejs</p><pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width,initial-scale=1.0,user-scalable=no<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>search<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>search<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>语音识别查电影<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://res.wx.qq.com/open/js/jweixin-1.6.0.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.bootcdn.net/ajax/libs/zepto/1.2.0/zepto.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token comment">/*
    1.绑定域名
        - 在接口测试号页面上填写js安全域名接口 不用写域名:"http://"
    2.引入js文件
        - http://res.wx.qq.com/open/js/jweixin-1.6.0.js
    3.通过config接口注入权限验证配置
     */</span>
    wx<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        debug<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。</span>
        appId<span class="token operator">:</span> <span class="token string">'wxd9cdd2f13c019b6d'</span><span class="token punctuation">,</span> <span class="token comment">// 必填，公众号的唯一标识</span>
        timestamp<span class="token operator">:</span> <span class="token string">'<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> timestamp </span><span class="token delimiter punctuation">%&gt;</span></span>'</span><span class="token punctuation">,</span> <span class="token comment">// 必填，生成签名的时间戳</span>
        nonceStr<span class="token operator">:</span> <span class="token string">'<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> noncestr </span><span class="token delimiter punctuation">%&gt;</span></span>'</span><span class="token punctuation">,</span> <span class="token comment">// 必填，生成签名的随机串</span>
        signature<span class="token operator">:</span> <span class="token string">'<span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> signature </span><span class="token delimiter punctuation">%&gt;</span></span>'</span><span class="token punctuation">,</span><span class="token comment">// 必填，签名</span>
        jsApiList<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">'onMenuShareQQ'</span><span class="token punctuation">,</span>
            <span class="token string">'onMenuShareQZone'</span><span class="token punctuation">,</span>
            <span class="token string">'startRecord'</span><span class="token punctuation">,</span>
            <span class="token string">'stopRecord'</span><span class="token punctuation">,</span>
            <span class="token string">'translateVoice'</span>
        <span class="token punctuation">]</span> <span class="token comment">// 必填，需要使用的JS接口列表</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//通过ready接口处理成功验证</span>
    wx<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。</span>
        <span class="token comment">// 对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。</span>

        <span class="token comment">//验证接口是否有权限</span>
        wx<span class="token punctuation">.</span><span class="token function">checkJsApi</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            jsApiList<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'onMenuShareQQ'</span><span class="token punctuation">,</span>
                <span class="token string">'onMenuShareQZone'</span><span class="token punctuation">,</span>
                <span class="token string">'startRecord'</span><span class="token punctuation">,</span>
                <span class="token string">'stopRecord'</span><span class="token punctuation">,</span>
                <span class="token string">'translateVoice'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 需要检测的JS接口列表，所有JS接口列表见附录2,</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 以键值对的形式返回，可用的api值true，不可用为false</span>
                <span class="token comment">// 如：{"checkResult":{"chooseImage":true},"errMsg":"checkJsApi:ok"}</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//设置标志位,是否在录音中</span>
        <span class="token keyword">var</span> isRecord <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">//语音识别功能</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#search'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//开始录音</span>
                wx<span class="token punctuation">.</span><span class="token function">startRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                isRecord <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//结束录音</span>
                wx<span class="token punctuation">.</span><span class="token function">stopRecord</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//结束录音后会自动上传录音到微信服务器中,微信服务器会返回一个id给开发者使用</span>
                        <span class="token keyword">var</span> localId <span class="token operator">=</span> res<span class="token punctuation">.</span>localId<span class="token punctuation">;</span>
                        <span class="token comment">//将录音转化为文字</span>
                        <span class="token comment">/*wx.translateVoice({
                            localId: localId, // 需要识别的音频的本地Id，由录音相关接口获得
                            isShowProgressTips: 1, // 默认为1，显示进度提示
                            success: function (res) {
                                alert(res.translateResult); // 语音识别的结果
                            }
                        });*/</span>
                        isRecord <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//通过error接口处理失败验证</span>
    wx<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>进入<a target="_blank" rel="noopener" href="https://www.bootcdn.cn/">BootCDN官网</a>,搜索<code>zepto</code>,复制第一个script标签即可</p><p>分享接口:</p><pre class="line-numbers language-none"><code class="language-none">wx.onMenuShareQQ({
  title: '', // 分享标题
  desc: '', // 分享描述
  link: '', // 分享链接
  imgUrl: '', // 分享图标
  success: function () {
  // 用户确认分享后执行的回调函数
  },
  cancel: function () {
  // 用户取消分享后执行的回调函数
  }
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="优化项目"><a href="#优化项目" class="headerlink" title="优化项目"></a>优化项目</h3><p>写了这么久的项目,是不是觉得项目十分的杂乱,这时候我们就需要对项目就行优化</p><p>因为auth,reply,template三个模块的作用都是拿到数据并做出反应给用户,所以我们可以把他们整合到一起</p><p>然后menu,wechat我们是用来实现自定义菜单功能的,我们今后可以将所有接口都放到wechat里面</p><p>在项目下新建文件夹reply,用来处理用户响应,反应给用户的一些模块,即将auth,reply,template三个模块放进去,将auth改名为index</p><p>修改app.js中的引入auth代码,修改为</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入reply模块</span>
<span class="token keyword">const</span> reply <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./reply'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>修改<code>app.use(auth())</code>为<code>app.use(reply())</code></p><p>提取app.js中的路由模块</p><p>在项目下新建router文件夹,新建index.js文件</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入express模块</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入sha1加密</span>
<span class="token keyword">const</span> sha1 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sha1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入config文件</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>url<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../config"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入wechat模块</span>
<span class="token keyword">const</span> Wechat <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../wechat/wechat"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入reply模块</span>
<span class="token keyword">const</span> reply <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../reply"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//获取Router</span>
<span class="token keyword">const</span> Router <span class="token operator">=</span> express<span class="token punctuation">.</span>Router<span class="token punctuation">;</span>
<span class="token comment">//创建路由器对象</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//创建实例对象</span>
<span class="token keyword">const</span> wechatApi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wechat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//页面路由</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/search'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//生成js-sdk需要使用的签名：</span>
    <span class="token comment">//随机字符串</span>
    <span class="token keyword">const</span> noncestr <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//时间戳</span>
    <span class="token keyword">const</span> timestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获取票据</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>ticket<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> wechatApi<span class="token punctuation">.</span><span class="token function">fetchTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//1.组合参与签名的4个参数:jsapi_ticket(临时票据),noncestr(随机字符串),timestamp(时间戳),url(当前服务器地址)</span>
    <span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">jsapi_ticket=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ticket<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">noncestr=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noncestr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">timestamp=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">url=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/search</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">]</span>
    <span class="token comment">//2.将其进行字典连续,并以'&amp;'拼接在一起</span>
    <span class="token keyword">const</span> str <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//xxx=xxx&amp;xxx=xxx&amp;xxx=xxx</span>
    <span class="token comment">//3.进行sha1加密,最终生成想要的signature</span>
    <span class="token keyword">const</span> signature <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//渲染页面,将渲染好的页面返回给用户</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'search'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        signature<span class="token punctuation">,</span>
        noncestr<span class="token punctuation">,</span>
        timestamp
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//接收处理所有参数</span>
router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">reply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//将路由器对象暴露出去</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改app.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入express模块</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入路由器模块</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//创建app应用对象</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//配置模板资源目录</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'views'</span><span class="token punctuation">,</span> <span class="token string">'./views'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//配置模板引擎</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'view engine'</span><span class="token punctuation">,</span> <span class="token string">'ejs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//应用路由器</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//监听端口号</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器启动成功'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="爬取浏览器数据"><a href="#爬取浏览器数据" class="headerlink" title="爬取浏览器数据"></a>爬取浏览器数据</h3><p>使用<code>puppeteer</code>库</p><p><a target="_blank" rel="noopener" href="https://github.com/puppeteer/puppeteer">github地址</a></p><p><a target="_blank" rel="noopener" href="https://github.com/puppeteer/puppeteer/blob/v13.1.3/docs/api.md">api文档</a></p><p>下载: <code>npm i puppeteer</code></p><p>puppeteer 在执行安装的过程中需要执行install.js，这里会下载Chromium，翻墙也下载失败，导致安装不成功，解决办法(使用淘宝镜像)：</p><blockquote><p>npm config set puppeteer_download_host=<a target="_blank" rel="noopener" href="https://npm.taobao.org/mirrors">https://npm.taobao.org/mirrors</a><br>npm i puppeteer</p></blockquote><p>我们只需要爬取8条数据</p><p>在项目下新建文件夹server,在里面再新建一个文件夹crawler,在其中新建theaterCrawler.js文件</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> puppeteer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'puppeteer'</span><span class="token punctuation">)</span>

<span class="token comment">//爬取热门电影信息</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'https://movie.douban.com/cinema/nowplaying/chongqing/'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//1.打开浏览器</span>
    <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// args: ['--no-sandbox'],</span>
        headless<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">//以无头浏览器形式打开浏览器,没有界面显示,在后台运行的8</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2.创建tab标签页</span>
    <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3.跳转到指定网址</span>
    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        waitUntil<span class="token operator">:</span> <span class="token string">'networkidle2'</span> <span class="token comment">//等待网络空闲时再跳转加载页面</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//4.等待网址加载完成,开始爬取数据</span>
    <span class="token comment">//开启延时器,延时2秒钟开始爬取数据</span>
    <span class="token keyword">await</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//对加载好的页面进行dom操作</span>
        <span class="token comment">//所有爬取的数据数组</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//获取所有热门电影的li</span>
        <span class="token keyword">const</span> $list <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#nowplaying&gt;.mod-bd&gt;.lists&gt;.list-item'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//只取8条数据</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> liDom <span class="token operator">=</span> $list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">//电影标题</span>
            <span class="token keyword">let</span> title <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>liDom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//电影评分</span>
            <span class="token keyword">let</span> rating <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>liDom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token string">'score'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//电影片长</span>
            <span class="token keyword">let</span> runtime <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>liDom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token string">'duration'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//导演</span>
            <span class="token keyword">let</span> directors <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>liDom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token string">'director'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//主演</span>
            <span class="token keyword">let</span> casts <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>liDom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token string">'actors'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//电影详情网址</span>
            <span class="token keyword">let</span> href <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>liDom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'.poster&gt;a'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//电影海报图</span>
            <span class="token keyword">let</span> image <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>liDom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'.poster&gt;a&gt;img'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//id</span>
            <span class="token keyword">let</span> doubanId <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>liDom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token string">'subject'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                title<span class="token punctuation">,</span>
                rating<span class="token punctuation">,</span>
                runtime<span class="token punctuation">,</span>
                directors<span class="token punctuation">,</span>
                casts<span class="token punctuation">,</span>
                href<span class="token punctuation">,</span>
                image<span class="token punctuation">,</span>
                doubanId
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//将爬取的数据返回出去</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//console.log(result);</span>

    <span class="token comment">//遍历爬取到的8条数据</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> result<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取每一条信息</span>
        <span class="token keyword">let</span> item <span class="token operator">=</span> result<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//获取电影详情网址</span>
        <span class="token keyword">let</span> url <span class="token operator">=</span> result<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>href<span class="token punctuation">;</span>
        <span class="token comment">//跳转到电影详情页</span>
        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            waitUntil<span class="token operator">:</span> <span class="token string">'networkidle2'</span> <span class="token comment">//等待网络空闲时再跳转加载页面</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//爬取其他数据</span>
        <span class="token keyword">let</span> itemResult <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> genre <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">//类型</span>
            <span class="token keyword">const</span> $genre <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'[property="v:genre"]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> $genre<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                genre<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>$genre<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>innerText<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//简介</span>
            <span class="token keyword">const</span> summary <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'[property="v:summary"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//上映日期</span>
            <span class="token keyword">const</span> releaseDate <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'[property="v:initialReleaseDate"]'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
            <span class="token comment">//给单个对象添加3个属性</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                genre<span class="token punctuation">,</span>
                summary<span class="token punctuation">,</span>
                releaseDate
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">//在最后给当前对象添加3个属性</span>
        <span class="token comment">//在evaluate函数中没办法读取到服务器中的变量</span>
        item<span class="token punctuation">.</span>genre <span class="token operator">=</span> itemResult<span class="token punctuation">.</span>genre<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>summary <span class="token operator">=</span> itemResult<span class="token punctuation">.</span>summary<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>releaseDate <span class="token operator">=</span> itemResult<span class="token punctuation">.</span>releaseDate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//5.关闭浏览器</span>
    <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在server文件夹下新建index.js文件</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> theatersCrawler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./crawler/theatersCrawler'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">theatersCrawler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行index.js得到如下数据:</p><pre class="line-numbers language-none"><code class="language-none">[                                                                          
  {                                                                        
    title: '四海',                                                         
    rating: 5.6,                                                           
    runtime: '128分钟',                                                    
    directors: '韩寒',                                                     
    casts: '刘昊然 / 刘浩存 / 沈腾',                                       
    href: 'https://movie.douban.com/subject/35337517/?from=playing_poster',
    image: 'https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2867433563.webp',
    doubanId: 35337517,
    genre: [ '喜剧', '动作', '爱情' ],
    summary: '在码头做摩托车特技表演顺便拉客的年轻人吴仁耀（刘昊然饰），他多年不见的浪荡父亲吴仁腾（沈腾饰）；梦想大城市生活的餐馆服务员周欢颂和他浮夸真诚的哥哥周
欢歌。一支从没有赢过一场比赛的“不败传说”车队频频出战，一群可笑又可爱的小人物命运交织。阿耀和欢颂都立志活成自己亲人的反面，想彼此取暖，彼此独立，却又总不在一个频道
上。世事无常，他们不得不背井离乡，迎接一场未知旅途，阿耀的一身技能竟会用在一个自己都意想不到的场合，他的亲情友情和爱情最终又将会是如何……',
    releaseDate: '2022-02-01(中国大陆)'
  },
  {
    title: '奇迹·笨小孩',
    rating: 7.4,
    runtime: '106分钟',
    directors: '文牧野',
    casts: '易烊千玺 / 田雨 / 陈哈琳',
    href: 'https://movie.douban.com/subject/35312437/?from=playing_poster',
    image: 'https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2842327103.webp',
    doubanId: 35312437,
    genre: [ '剧情' ],
    summary: '二十岁的景浩（易烊千玺饰）独自带着年幼的妹妹来到深圳生活，兄妹俩生活温馨却拮据。为了妹妹高昂的手术费，机缘巧合之下，景浩得到一个机会，本以为美好生活
即将来临，却不料遭遇重创。在时间和金钱的双重压力下，毫无退路的景浩决定孤注一掷，而他陷入困境的平凡人生，又能否燃起希望的火花？&lt;br&gt;电影《奇迹》是中宣部国家电影局20
21年重点电影项目，也是2021年重点建党百年献礼片，描述十八大以后新时代年轻人在深圳创业的影片。',
    releaseDate: '2022-02-01(中国大陆)'
  },
  {
    title: '这个杀手不太冷静',
    rating: 6.9,
    runtime: '109分钟',
    directors: '邢文雄',
    casts: '马丽 / 魏翔 / 陈明昊',
    href: 'https://movie.douban.com/subject/35505100/?from=playing_poster',
    image: 'https://img3.doubanio.com/view/photo/s_ratio_poster/public/p2814949620.webp',
    doubanId: 35505100,
    genre: [ '喜剧' ],
    summary: '毕生追求男主梦的魏成功（魏翔饰）终于得到了女明星米兰（马丽饰）的“赏识”，被邀请出演她的男一号“杀手卡尔”，他兴致勃勃诠释角色的同时，却没想到已经落入了
一场危机四伏的阴谋，但他依然借自己“精湛”的演技和绝佳的运气化险为夷，而残酷的真相也离他越来越近……',
    releaseDate: '2022-02-01(中国大陆)'
  },
  {
    title: '长津湖之水门桥',
    rating: 7.2,
    runtime: '149分钟',
    directors: '徐克',
    casts: '吴京 / 易烊千玺 / 朱亚文',
    href: 'https://movie.douban.com/subject/35613853/?from=playing_poster',
    image: 'https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2846021991.webp',
    doubanId: 35613853,
    genre: [ '剧情', '历史', '战争' ],
    summary: '电影以抗美援朝战争第二次战役中的长津湖战役为背景，讲述了在结束了新兴里和下碣隅里的战斗之后，七连战士们又接到了更艰巨的任务……',
    releaseDate: '2022-02-01(中国大陆)'
  },
  {
    title: '狙击手',
    rating: 7.7,
    runtime: '96分钟',
    directors: '张艺谋 张末',
    casts: '陈永胜 / 章宇 / 张译',
    href: 'https://movie.douban.com/subject/35215390/?from=playing_poster',
    image: 'https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2738601191.webp',
    doubanId: 35215390,
    genre: [ '剧情', '历史', '战争' ],
    summary: '影片根据抗美援朝战争“冷枪冷炮”运动中神枪手群体事迹改编。1952年冬至1953年初，中国人民志愿军与联合国军在朝鲜战场形成僵持，双方发起了低强度的密集狙击战
，史称"冷枪冷炮运动"。在连长（张译饰）带领下的狙击五班战士枪法过人，成为敌军的心头大患，班长刘文武（章宇饰）更成为重点狙击对象。为重创狙击五班，敌方调配精英狙击小
队，配以最先进的武器装备，更迫使狙击五班战士大永（陈永胜饰）等人为救同伴进入其设好的险境之地。但正当敌军打响自己如意算盘之时，他们未料到，被他们当作诱饵的侦察兵亮
亮（刘奕铁饰）身上其实隐藏着更大的秘密......',
    releaseDate: '2022-02-01(中国大陆)'
  },
  {
    title: '喜羊羊与灰太狼之筐出未来',
    rating: 0,
    runtime: '94分钟',
    directors: '黄伟明',
    casts: '祖晴 / 张琳 / 邓玉婷',
    href: 'https://movie.douban.com/subject/35608160/?from=playing_poster',
    image: 'https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2797468943.webp',
    doubanId: 35608160,
    genre: [ '喜剧', '动画', '运动' ],
    summary: '喜羊羊、灰太狼与一众小羊组成的守护者队进入篮球顶级赛事决赛，但却意外地败北，团队分崩离析。&lt;br&gt;虽然各散东西，但对篮球的热爱和对冠军的渴望让大家再次组
队，参加新一届大赛，然而这次的对手更强大，他们面临更大的挑战！',
    releaseDate: '2022-02-01(中国大陆)'
  },
  {
    title: '熊出没·重返地球',
    rating: 0,
    runtime: '99分钟',
    directors: '林汇达',
    casts: '张秉君 / 张伟 / 谭笑',
    href: 'https://movie.douban.com/subject/35377026/?from=playing_poster',
    image: 'https://img2.doubanio.com/view/photo/s_ratio_poster/public/p2856825681.webp',
    doubanId: 35377026,
    genre: [ '喜剧', '动画', '儿童' ],
    summary: '有点懒又有点馋的熊二虽然总是各种失误犯错，内心却一直梦想成为一位英雄，以此获得大家特别是哥哥熊大的认可。&lt;br&gt;一块外星原核的坠落打破了狗熊岭的平静，熊
二意外的与外星原核合体，成为了拥有外星智慧能量的熊！随之而来的是“外星人”阿布的抢夺。阿布为了夺回原核，故意制造事端，让熊二众叛亲离。就在阿布将要成功的时候，一支神
秘高科技军团的攻击彻底打乱了计划，导致熊强组合甚至整个地球于巨大的危难之中。&lt;br&gt;阿布隐藏的身份以及来到地球的真正目的到底是什么？神秘的高科技军团背后有何故事？自暴
自弃的熊二能否振作起来实现他的英雄梦？他们能否挽救地球的危机？',
    releaseDate: '2022-02-01(中国大陆)'
  },
  {
    title: '李茂扮太子',
    rating: 4.3,
    runtime: '100分钟',
    directors: '高可',
    casts: '马丽 / 常远 / 艾伦',
    href: 'https://movie.douban.com/subject/35444998/?from=playing_poster',
    image: 'https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2812626447.webp',
    doubanId: 35444998,
    genre: [ '喜剧', '古装' ],
    summary: '富家女杨家珍（马丽饰）与小捕快李茂（常远饰）成婚，虽夫妻恩爱，但始终得不到家珍父母的认可。李茂意外发现自己竟与当朝太子相貌相同，一个想进宫获得晋升，
一个想出宫获得自由，二人交换身份，却不知正一步步卷入尚书的阴谋里……',
    releaseDate: '2022-01-01(中国大陆)'
  }
]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="保存数据到数据库"><a href="#保存数据到数据库" class="headerlink" title="保存数据到数据库"></a>保存数据到数据库</h3><p>在项目下新建db文件夹,在其中新建index.js文件,需要下载mongoose包:<code>npm install mongoose</code></p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/TM0831/p/10606624.html">安装mongoDB</a></p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入mongoose</span>
<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//连接数据库</span>
    mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mongodb://localhost:27017/movie'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>useNewUrlParser<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//绑定事件监听</span>
    mongoose<span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'数据库连接成功~~'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'数据库连接失败:'</span><span class="token operator">+</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在项目下新建model文件夹,在其中新建Theaters.js文件</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入mongoose</span>
<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//获取Schema</span>
<span class="token keyword">const</span> Schema <span class="token operator">=</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">;</span>
<span class="token comment">//创建约束对象</span>
<span class="token keyword">const</span> theatersSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    title<span class="token operator">:</span> String<span class="token punctuation">,</span>
    rating<span class="token operator">:</span> Number<span class="token punctuation">,</span>
    runtime<span class="token operator">:</span> String<span class="token punctuation">,</span>
    directors<span class="token operator">:</span> String<span class="token punctuation">,</span>
    casts<span class="token operator">:</span> String<span class="token punctuation">,</span>
    image<span class="token operator">:</span> String<span class="token punctuation">,</span>
    doubanId<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> Number<span class="token punctuation">,</span>
        unique<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    genre<span class="token operator">:</span> <span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">,</span>
    summary<span class="token operator">:</span> String<span class="token punctuation">,</span>
    releaseDate<span class="token operator">:</span> String<span class="token punctuation">,</span>
    posterKey<span class="token operator">:</span> String<span class="token punctuation">,</span><span class="token comment">//图片上传到七牛中返回的key值</span>
    createTime<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> Date<span class="token punctuation">,</span>
        <span class="token keyword">default</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//创建模型对象</span>
<span class="token keyword">const</span> Theaters <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Theaters'</span><span class="token punctuation">,</span>theatersSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//暴露出去</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Theaters<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在server文件夹下新建save文件夹,并在其中新建saveTheaters.js文件用来保存实现保存操作的内容</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入Theaters</span>
<span class="token keyword">const</span> Theaters <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../model/Theaters'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> item <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> Theaters<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            title<span class="token operator">:</span> item<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
            rating<span class="token operator">:</span> item<span class="token punctuation">.</span>rating<span class="token punctuation">,</span>
            runtime<span class="token operator">:</span> item<span class="token punctuation">.</span>runtime<span class="token punctuation">,</span>
            directors<span class="token operator">:</span> item<span class="token punctuation">.</span>directors<span class="token punctuation">,</span>
            casts<span class="token operator">:</span> item<span class="token punctuation">.</span>casts<span class="token punctuation">,</span>
            image<span class="token operator">:</span> item<span class="token punctuation">.</span>image<span class="token punctuation">,</span>
            doubanId<span class="token operator">:</span> item<span class="token punctuation">.</span>doubanId<span class="token punctuation">,</span>
            genre<span class="token operator">:</span> item<span class="token punctuation">.</span>genre<span class="token punctuation">,</span>
            summary<span class="token operator">:</span> item<span class="token punctuation">.</span>summary<span class="token punctuation">,</span>
            releaseDate<span class="token operator">:</span> item<span class="token punctuation">.</span>releaseDate<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'数据保存成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在关闭浏览器后将数据返回出去:在theatersCrawler.js中关闭浏览器代码后添加<code>return result;</code></p><p>修改server文件夹下面的index文件</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> theatersCrawler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./crawler/theatersCrawler'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> saveTheaters <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./save/saveTheaters'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//连接数据库</span>
    <span class="token keyword">await</span> db<span class="token punctuation">;</span>
    <span class="token comment">//爬取数据</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">theatersCrawler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将爬取的数据保存到数据库中</span>
    <span class="token keyword">await</span> <span class="token function">saveTheaters</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在数据库中执行:<code>db.theaters.find({})</code> 查看数据保存情况</p><h3 id="回复用户热门电影数据"><a href="#回复用户热门电影数据" class="headerlink" title="回复用户热门电影数据"></a>回复用户热门电影数据</h3><p>修改reply下的reply.js文件</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入Theaters</span>
<span class="token keyword">const</span> Theaters <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/Theaters'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//引入config</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>url<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//需要将该函数改为async函数</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>Content <span class="token operator">===</span> <span class="token string">'热门'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//全匹配</span>
            <span class="token comment">//回复用户热门电影数据</span>
            <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> Theaters<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>title<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> summary<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> image<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> doubanId<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> _id<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将回复内容改为空数组</span>
            content <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            options<span class="token punctuation">.</span>msgType <span class="token operator">=</span> <span class="token string">'news'</span><span class="token punctuation">;</span>
            <span class="token comment">//通过变量将数据添加进去</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> item <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                content<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    title<span class="token operator">:</span> item<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
                    description<span class="token operator">:</span> item<span class="token punctuation">.</span>summary<span class="token punctuation">,</span>
                    picUrl<span class="token operator">:</span> item<span class="token punctuation">.</span>image<span class="token punctuation">,</span>
                    url<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/detail/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>doubanId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将reply下的index.js文件中的<code>const options = reply(message);</code>改为</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//将reply改为了async函数,返回值变为了promise对象</span>
<span class="token comment">//必须用await关键字才能拿到最终的返回值</span>
<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">reply</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="电影详情页面"><a href="#电影详情页面" class="headerlink" title="电影详情页面"></a>电影详情页面</h3><p>router的index.js中,在搜索页面路由下添加电影详情页面路由</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入Theaters</span>
<span class="token keyword">const</span> Theaters <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/Theaters'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//详情页面路由</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/detail/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取占位符id的值</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
    <span class="token comment">//判断id值是否存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//去数据库中找到对应id值的所有数据</span>
        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> Theaters<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>doubanId<span class="token operator">:</span> id<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>_id<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> __v<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> createTime<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> doubanId<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//渲染到页面上</span>
        res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'detail'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>data<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>电影详情页</p><pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>movie<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>header</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>header_title<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/movie<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>电影<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>header_search<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/search<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>搜索<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>header</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>page<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> data<span class="token punctuation">.</span>title </span><span class="token delimiter punctuation">%&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>info<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>left<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rating<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>评分：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span><span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> data<span class="token punctuation">.</span>rating </span><span class="token delimiter punctuation">%&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ratingNum<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>98375人评价<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>meta<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> data<span class="token punctuation">.</span>runtime </span><span class="token delimiter punctuation">%&gt;</span></span> /
                    <span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> data<span class="token punctuation">.</span>genre<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token punctuation">{</span> </span><span class="token delimiter punctuation">%&gt;</span></span>
                        <span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> item </span><span class="token delimiter punctuation">%&gt;</span></span> /
                    <span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%</span><span class="token language-javascript"> <span class="token punctuation">}</span><span class="token punctuation">)</span> </span><span class="token delimiter punctuation">%&gt;</span></span>
                    <span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> data<span class="token punctuation">.</span>directors </span><span class="token delimiter punctuation">%&gt;</span></span>(导演) / <span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> data<span class="token punctuation">.</span>casts </span><span class="token delimiter punctuation">%&gt;</span></span> / <span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> data<span class="token punctuation">.</span>releaseDate </span><span class="token delimiter punctuation">%&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>right<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>javascript:<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> data<span class="token punctuation">.</span>image </span><span class="token delimiter punctuation">%&gt;</span></span><span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> data<span class="token punctuation">.</span>title </span><span class="token delimiter punctuation">%&gt;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>intro<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span><span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> data<span class="token punctuation">.</span>title </span><span class="token delimiter punctuation">%&gt;</span></span>的简介<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> data<span class="token punctuation">.</span>summary </span><span class="token delimiter punctuation">%&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="文本搜索电影"><a href="#文本搜索电影" class="headerlink" title="文本搜索电影"></a>文本搜索电影</h3><p>在匹配的最后加一个else判断,用来搜索用户输入指定电影信息</p><p>reply.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入rp</span>
<span class="token keyword">const</span> rp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'request-promise-native'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//搜索用户输入指定电影信息</span>
    <span class="token comment">//定义请求地址</span>
    <span class="token comment">//这种写法会导致message.Content变为一些%之类的码</span>
    <span class="token comment">//const url = `https://api.douban.com/v2/movie/search?q=${message.Content}&amp;count=8`;</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'https://api.douban.com/v2/movie/search'</span><span class="token punctuation">;</span>
    <span class="token comment">//发送请求</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>subjects<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">rp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> json<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> qs<span class="token operator">:</span> <span class="token punctuation">{</span>q<span class="token operator">:</span> message<span class="token punctuation">.</span>Content<span class="token punctuation">,</span> count<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//判断subjects是否有值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subjects <span class="token operator">&amp;&amp;</span> subjects<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//有数据,返回一个图文消息给用户</span>
        <span class="token comment">//将回复内容改为空数组</span>
        content <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span>msgType <span class="token operator">=</span> <span class="token string">'news'</span><span class="token punctuation">;</span>
        <span class="token comment">//通过变量将数据添加进去</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> subjects<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> item <span class="token operator">=</span> subjects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            content<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                title<span class="token operator">:</span> item<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
                description<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">电影评分为:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>rating<span class="token punctuation">.</span>average<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
                picUrl<span class="token operator">:</span> item<span class="token punctuation">.</span>image<span class="token punctuation">.</span>small<span class="token punctuation">,</span>
                url<span class="token operator">:</span> item<span class="token punctuation">.</span>alt
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//无数据</span>
        content <span class="token operator">=</span> <span class="token string">"暂时没有电影信息"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="上传图片到七牛"><a href="#上传图片到七牛" class="headerlink" title="上传图片到七牛"></a>上传图片到七牛</h3><p><a target="_blank" rel="noopener" href="https://www.qiniu.com/?utm_source=%E7%99%BE%E5%BA%A6%E5%93%81%E4%B8%93&amp;utm_medium=CPM&amp;utm_term=logo&amp;utm_content=%E5%B7%A6%E4%BE%A7logo&amp;utm_campaign=%E7%99%BE%E5%BA%A6%E5%93%81%E4%B8%93">七牛官网</a></p><p>注册并登录</p><p>点击控制台-&gt;资源管理下的存储空间-&gt;新建存储空间(填写信息后确认创建)</p><p>我们上传成功之后,只需复制外链使用即可</p><p>文档:文档中心-&gt;SDK&amp;工具-&gt;官方SDK-&gt;Node.js 服务器</p><p>安装依赖: <code>npm i qiniu -D</code></p><p>在server文件夹下新建qiniu文件夹,并在其中新建upload.js、index.js文件</p><p>upload.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入qiniu</span>
<span class="token keyword">const</span> qiniu <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'qiniu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//个人中心-&gt;秘钥管理</span>
<span class="token keyword">var</span> accessKey <span class="token operator">=</span> <span class="token string">'your access key'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> secretKey <span class="token operator">=</span> <span class="token string">'your secret key'</span>
<span class="token comment">//定义鉴权对象</span>
<span class="token keyword">var</span> mac <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>digest<span class="token punctuation">.</span>Mac</span><span class="token punctuation">(</span>accessKey<span class="token punctuation">,</span> secretKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//定义配置对象</span>
<span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//存储区域   z0 -- 华东  z1 -- 华北  z2 -- 华南</span>
config<span class="token punctuation">.</span>zone <span class="token operator">=</span> qiniu<span class="token punctuation">.</span>zone<span class="token punctuation">.</span>Zone_z2<span class="token punctuation">;</span>
<span class="token comment">//bucketManager对象上就有所有方法</span>
<span class="token keyword">var</span> bucketManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">qiniu<span class="token punctuation">.</span>rs<span class="token punctuation">.</span>BucketManager</span><span class="token punctuation">(</span>mac<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bucket <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">resUrl<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    resUrl  网络资源地址
    bucket  存储空间名称
     */</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        bucketManager<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span>resUrl<span class="token punctuation">,</span> bucket<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> respBody<span class="token punctuation">,</span> respInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//throw err;</span>
                <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'上传图片方法出了问题'</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>respInfo<span class="token punctuation">.</span>statusCode <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'文件上传成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>index.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">/*
将数据库中的图片上传到七牛
 */</span>
<span class="token comment">//模型对象</span>
<span class="token keyword">const</span> Theaters <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../model/Theaters'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//上传图片到七牛方法</span>
<span class="token keyword">const</span> upload <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./upload'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//生成唯一的key值</span>
<span class="token keyword">const</span> nanoid <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'nanoid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    1.获取数据库中的图片链接
    2.上传到七牛
    3.保存key值到数据库中
     */</span>
    <span class="token comment">//去数据库中所有没有上传图片的文档对象</span>
    <span class="token comment">//const movies = await Theaters.find({posterKey: {$in: ['', null, {$exists: false}]}})</span>
    <span class="token keyword">const</span> movies <span class="token operator">=</span> <span class="token keyword">await</span> Theaters<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        $or<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>posterKey<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>posterKey<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>posterKey<span class="token operator">:</span> <span class="token punctuation">{</span>$exists<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">//遍历每一条数据</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> movies<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取每一个文档对象</span>
        <span class="token keyword">let</span> movie <span class="token operator">=</span> movies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//上传到七牛中</span>
        <span class="token keyword">let</span> url <span class="token operator">=</span> movie<span class="token punctuation">.</span>image<span class="token punctuation">;</span>
        <span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">nanoid</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.jpg</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">upload</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//保存key值到数据库中</span>
        movie<span class="token punctuation">.</span>posterKey <span class="token operator">=</span> key<span class="token punctuation">;</span>
        <span class="token keyword">await</span> movie<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改server文件夹下的index.js文件</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> theatersCrawler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./crawler/theatersCrawler'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> saveTheaters <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./save/saveTheaters'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uploadToQiniu <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./qiniu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//连接数据库</span>
    <span class="token keyword">await</span> db<span class="token punctuation">;</span>
    <span class="token comment">//爬取数据</span>
    <span class="token comment">//const data = await theatersCrawler();</span>
    <span class="token comment">//将爬取的数据保存到数据库中</span>
    <span class="token comment">//await saveTheaters(data);</span>
    <span class="token comment">//上传图片到七牛中</span>
    <span class="token keyword">await</span> <span class="token function">uploadToQiniu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行server文件夹下的index.js文件</p><p>nanoid库:生成唯一key值<br>下载: <code>npm i nanoid -D</code></p><p>修改reply.js回复热门下面的picUrl为:</p><p>picUrl: <code>http://r6v3vcdm2.hn-bkt.clouddn.com/${item.posterKey}</code>,</p><h3 id="爬取预告片电影数据"><a href="#爬取预告片电影数据" class="headerlink" title="爬取预告片电影数据"></a>爬取预告片电影数据</h3><p>跟之前爬取热门电影一样,我们先在server文件夹下的crawler文件夹下新建trailersCrawler.js文件用来爬取预告片电影数据</p><p>trailersCrawler.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> puppeteer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'puppeteer'</span><span class="token punctuation">)</span>

<span class="token comment">//爬取热门电影信息</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'https://movie.douban.com/coming'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//1.打开浏览器</span>
    <span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// args: ['--no-sandbox'],</span>
        headless<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">//以无头浏览器形式打开浏览器,没有界面显示,在后台运行的8</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2.创建tab标签页</span>
    <span class="token keyword">const</span> page <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3.跳转到指定网址</span>
    <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        waitUntil<span class="token operator">:</span> <span class="token string">'networkidle2'</span> <span class="token comment">//等待网络空闲时再跳转加载页面</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//4.等待网址加载完成,开始爬取数据</span>
    <span class="token comment">//开启延时器,延时2秒钟开始爬取数据</span>
    <span class="token keyword">await</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//一、爬取所有预告片详情页面网址</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//对加载好的页面进行dom操作</span>
        <span class="token comment">//所有爬取的数据数组</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//获取所有即将上映电影</span>
        <span class="token keyword">const</span> $trs <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.coming_list&gt;tbody&gt;tr'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> $trs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> trDom <span class="token operator">=</span> $trs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">//获取想看的人数</span>
            <span class="token keyword">let</span> num <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span>trDom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'td'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//判断num大小</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">&gt;</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//想看人数大于1000才叫好</span>
                <span class="token comment">//电影详情页面</span>
                <span class="token keyword">let</span> href <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>trDom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//将爬取的数据返回出去</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//console.log(result);</span>
    <span class="token comment">//所有电影数据的数组</span>
    <span class="token keyword">let</span> moviesData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//二、爬取主要的数据</span>
    <span class="token comment">//遍历爬取到的数据</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> result<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取电影详情网址</span>
        <span class="token keyword">let</span> url <span class="token operator">=</span> result<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//跳转到电影详情页</span>
        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            waitUntil<span class="token operator">:</span> <span class="token string">'networkidle2'</span> <span class="token comment">//等待网络空闲时再跳转加载页面</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//爬取其他数据</span>
        <span class="token keyword">let</span> itemResult <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//预告片电影网址</span>
            <span class="token keyword">const</span> href <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.related-pic-video'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>href<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//标题</span>
            <span class="token keyword">let</span> title <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'[property="v:itemreviewed"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//导演</span>
            <span class="token keyword">let</span> directors <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'[rel="v:directedBy"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//海报图</span>
            <span class="token keyword">let</span> image <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'[rel="v:image"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//豆瓣id</span>
            <span class="token keyword">let</span> doubanId <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.lnk-sharing'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'share-id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//演员</span>
            <span class="token keyword">let</span> casts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> $star <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'[rel="v:starring"]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> length <span class="token operator">=</span> $star<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">3</span> <span class="token operator">?</span> <span class="token number">3</span> <span class="token operator">:</span> $star<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                casts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>$star<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>innerText<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//类型</span>
            <span class="token keyword">let</span> genre <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> $genre <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'[property="v:genre"]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> $genre<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                genre<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>$genre<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>innerText<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//简介</span>
            <span class="token keyword">const</span> summary <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'[property="v:summary"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//上映日期</span>
            <span class="token keyword">const</span> releaseDate <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'[property="v:initialReleaseDate"]'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>innerText<span class="token punctuation">;</span>
            <span class="token comment">//片长</span>
            <span class="token keyword">const</span> runTime <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'[property="v:runtime"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//封面图片</span>
            <span class="token keyword">const</span> cover <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.related-pic-video'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'background-image'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//给单个对象添加3个属性</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                title<span class="token punctuation">,</span>
                directors<span class="token punctuation">,</span>
                casts<span class="token punctuation">,</span>
                genre<span class="token punctuation">,</span>
                image<span class="token punctuation">,</span>
                summary<span class="token punctuation">,</span>
                releaseDate<span class="token punctuation">,</span>
                doubanId<span class="token punctuation">,</span>
                runTime<span class="token punctuation">,</span>
                href<span class="token punctuation">,</span>
                cover
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>itemResult<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            moviesData<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>itemResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//console.log(moviesData);</span>
    <span class="token comment">//三、爬取预告片电影链接</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> moviesData<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> item <span class="token operator">=</span> moviesData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> url <span class="token operator">=</span> item<span class="token punctuation">.</span>href<span class="token punctuation">;</span>
        <span class="token comment">//跳转到电影详情页</span>
        <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            waitUntil<span class="token operator">:</span> <span class="token string">'networkidle2'</span> <span class="token comment">//等待网络空闲时再跳转加载页面</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//爬取其他数据</span>
        item<span class="token punctuation">.</span>link <span class="token operator">=</span> <span class="token keyword">await</span> page<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//电影链接</span>
            <span class="token keyword">return</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'video&gt;source'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>moviesData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//5.关闭浏览器</span>
    <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> moviesData<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改server文件夹下的index.js文件并运行测试是否爬取到数据</p><p>index.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> theatersCrawler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./crawler/theatersCrawler'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> trailersCrawler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./crawler/trailersCrawler'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> saveTheaters <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./save/saveTheaters'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uploadToQiniu <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./qiniu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//连接数据库</span>
    <span class="token comment">//await db;</span>
    <span class="token comment">//爬取数据</span>
    <span class="token comment">//const data = await theatersCrawler();</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">trailersCrawler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将爬取的数据保存到数据库中</span>
    <span class="token comment">//await saveTheaters(data);</span>
    <span class="token comment">//上传图片到七牛中</span>
    <span class="token comment">//await uploadToQiniu();</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们同样在server文件夹下的save文件夹下新建saveTrailers.js用来将爬取到的数据保存到数据库</p><p>saveTrailers.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入Trailers</span>
<span class="token keyword">const</span> Trailers <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../model/Trailers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> item <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> Trailers<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            title<span class="token operator">:</span> item<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
            runtime<span class="token operator">:</span> item<span class="token punctuation">.</span>runtime<span class="token punctuation">,</span>
            directors<span class="token operator">:</span> item<span class="token punctuation">.</span>directors<span class="token punctuation">,</span>
            casts<span class="token operator">:</span> item<span class="token punctuation">.</span>casts<span class="token punctuation">,</span>
            image<span class="token operator">:</span> item<span class="token punctuation">.</span>image<span class="token punctuation">,</span>
            doubanId<span class="token operator">:</span> item<span class="token punctuation">.</span>doubanId<span class="token punctuation">,</span>
            cover<span class="token operator">:</span> item<span class="token punctuation">.</span>cover<span class="token punctuation">,</span>
            genre<span class="token operator">:</span> item<span class="token punctuation">.</span>genre<span class="token punctuation">,</span>
            summary<span class="token operator">:</span> item<span class="token punctuation">.</span>summary<span class="token punctuation">,</span>
            releaseDate<span class="token operator">:</span> item<span class="token punctuation">.</span>releaseDate<span class="token punctuation">,</span>
            link<span class="token operator">:</span> item<span class="token punctuation">.</span>link<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'数据保存成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Trailers.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//引入mongoose</span>
<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//获取Schema</span>
<span class="token keyword">const</span> Schema <span class="token operator">=</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">;</span>
<span class="token comment">//创建约束对象</span>
<span class="token keyword">const</span> trailersSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    title<span class="token operator">:</span> String<span class="token punctuation">,</span>
    runtime<span class="token operator">:</span> String<span class="token punctuation">,</span>
    directors<span class="token operator">:</span> String<span class="token punctuation">,</span>
    casts<span class="token operator">:</span> <span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">,</span>
    image<span class="token operator">:</span> String<span class="token punctuation">,</span>
    doubanId<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> Number<span class="token punctuation">,</span>
        unique<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    genre<span class="token operator">:</span> <span class="token punctuation">[</span>String<span class="token punctuation">]</span><span class="token punctuation">,</span>
    cover<span class="token operator">:</span> String<span class="token punctuation">,</span>
    summary<span class="token operator">:</span> String<span class="token punctuation">,</span>
    releaseDate<span class="token operator">:</span> String<span class="token punctuation">,</span>
    link<span class="token operator">:</span>String<span class="token punctuation">,</span>
    posterKey<span class="token operator">:</span> String<span class="token punctuation">,</span><span class="token comment">//图片上传到七牛中返回的key值</span>
    coverKey<span class="token operator">:</span> String<span class="token punctuation">,</span><span class="token comment">//视频封面图</span>
    videoKey<span class="token operator">:</span> String<span class="token punctuation">,</span><span class="token comment">//预告片</span>
    createTime<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> Date<span class="token punctuation">,</span>
        <span class="token keyword">default</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//创建模型对象</span>
<span class="token keyword">const</span> Trailers <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Trailers'</span><span class="token punctuation">,</span> trailersSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//暴露出去</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Trailers<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改server文件夹下的index.js文件并运行测试保存数据是否成功</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> theatersCrawler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./crawler/theatersCrawler'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> trailersCrawler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./crawler/trailersCrawler'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> saveTheaters <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./save/saveTheaters'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> saveTrailers <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./save/saveTrailers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uploadToQiniu <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./qiniu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//连接数据库</span>
    <span class="token keyword">await</span> db<span class="token punctuation">;</span>
    <span class="token comment">//爬取数据</span>
    <span class="token comment">//const data = await theatersCrawler();</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">trailersCrawler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将爬取的数据保存到数据库中</span>
    <span class="token comment">//await saveTheaters(data);</span>
    <span class="token keyword">await</span> <span class="token function">saveTrailers</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//上传图片到七牛中</span>
    <span class="token comment">//await uploadToQiniu();</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>打开数据库即可查看</p><h3 id="重新定义上传七牛的方法"><a href="#重新定义上传七牛的方法" class="headerlink" title="重新定义上传七牛的方法"></a>重新定义上传七牛的方法</h3><p>修改server文件夹下的qiniu文件夹下的index.js文件</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">/*
将数据库中的图片上传到七牛
 */</span>
<span class="token comment">//上传图片到七牛方法</span>
<span class="token keyword">const</span> upload <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./upload'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//生成唯一的key值</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>nanoid<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'nanoid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> Model</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    1.获取数据库中的图片链接
    2.上传到七牛
    3.保存key值到数据库中
     */</span>
    <span class="token comment">//去数据库中所有没有上传图片的文档对象</span>
    <span class="token comment">//const movies = await Model.find({posterKey: {$in: ['', null, {$exists: false}]}})</span>
    <span class="token keyword">const</span> movies <span class="token operator">=</span> <span class="token keyword">await</span> Model<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        $or<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">{</span>$exists<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">//遍历每一条数据</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> movies<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取每一个文档对象</span>
        <span class="token keyword">let</span> movie <span class="token operator">=</span> movies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//初始化</span>
        <span class="token keyword">let</span> url <span class="token operator">=</span> movie<span class="token punctuation">.</span>image<span class="token punctuation">;</span>
        <span class="token keyword">let</span> filename <span class="token operator">=</span> <span class="token string">'.jpg'</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'coverKey'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            url <span class="token operator">=</span> movie<span class="token punctuation">.</span>cover<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'videoKey'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            url <span class="token operator">=</span> movie<span class="token punctuation">.</span>link<span class="token punctuation">;</span>
            filename <span class="token operator">=</span> <span class="token string">'.mp4'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//文件名</span>
        filename <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">nanoid</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token comment">//上传到七牛中</span>
        <span class="token keyword">await</span> <span class="token function">upload</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//保存key值到数据库中</span>
        movie<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> filename<span class="token punctuation">;</span>
        <span class="token keyword">await</span> movie<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改server文件夹下的index.js文件并运行测试上传七牛是否成功</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> theatersCrawler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./crawler/theatersCrawler'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> trailersCrawler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./crawler/trailersCrawler'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> saveTheaters <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./save/saveTheaters'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> saveTrailers <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./save/saveTrailers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uploadToQiniu <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./qiniu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Theaters <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/Theaters'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Trailers <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/Trailers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//连接数据库</span>
    <span class="token keyword">await</span> db<span class="token punctuation">;</span>
    <span class="token comment">//爬取数据</span>
    <span class="token comment">//const data = await theatersCrawler();</span>
    <span class="token comment">//const data = await trailersCrawler();</span>
    <span class="token comment">//将爬取的数据保存到数据库中</span>
    <span class="token comment">//await saveTheaters(data);</span>
    <span class="token comment">//await saveTrailers(data);</span>
    <span class="token comment">//上传图片到七牛中</span>
    <span class="token comment">//await uploadToQiniu('posterKey', Theaters);</span>
    <span class="token keyword">await</span> <span class="token function">uploadToQiniu</span><span class="token punctuation">(</span><span class="token string">'coverKey'</span><span class="token punctuation">,</span> Trailers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">uploadToQiniu</span><span class="token punctuation">(</span><span class="token string">'posterKey'</span><span class="token punctuation">,</span> Trailers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">uploadToQiniu</span><span class="token punctuation">(</span><span class="token string">'videoKey'</span><span class="token punctuation">,</span> Trailers<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="搭建预告片静态页面"><a href="#搭建预告片静态页面" class="headerlink" title="搭建预告片静态页面"></a>搭建预告片静态页面</h3><p>可自行搭建movie.html</p><h3 id="搭建预告片ejs页面"><a href="#搭建预告片ejs页面" class="headerlink" title="搭建预告片ejs页面"></a>搭建预告片ejs页面</h3><p>在router文件夹的index.js中添加电影预告片路由</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> Trailers <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/Trailers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//预告片页面路由</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/movie'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//去数据库中找到所有预告片电影数据</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> Trailers<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>_id<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> __v<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>cover<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>link<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>image<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//渲染到页面上</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'movie'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>data<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改movie.html为movie.ejs,同之前的search.ejs修改即可</p><h3 id="预告片视频功能"><a href="#预告片视频功能" class="headerlink" title="预告片视频功能"></a>预告片视频功能</h3><p>可以使用一个叫DPlayer的库,可以去<a target="_blank" rel="noopener" href="https://github.com/DIYgod/DPlayer">github</a>查看一下<br><a target="_blank" rel="noopener" href="http://dplayer.js.org/guide.html#quick-start">文档</a></p><p><a target="_blank" rel="noopener" href="https://www.bootcdn.cn/dplayer/">bootcdn地址</a></p><h3 id="获取media-id"><a href="#获取media-id" class="headerlink" title="获取media-id"></a>获取media-id</h3><p>我们在项目下新建media文件夹来存放素材</p><p>在utils文件夹中的api.js新增接口</p><pre class="line-numbers language-js" data-language="js"><code class="language-js">temporary<span class="token operator">:</span> <span class="token punctuation">{</span>
    upload<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">media/upload?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    get<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">media/get?</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
permanent<span class="token operator">:</span> <span class="token punctuation">{</span>
    uploadNews<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">material/add_news?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    uploadImg<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">media/uploadimg?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    uploadOthers<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">material/add_material?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    get<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">material/get_material?</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="上传临时素材"><a href="#上传临时素材" class="headerlink" title="上传临时素材"></a>上传临时素材</h4><p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/offiaccount/Asset_Management/New_temporary_materials.html">官方文档</a></p><p>我们在wechat.js添加方法</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//fs模块</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>createReadStream<span class="token punctuation">}</span><span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//path 模块</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>resolve<span class="token punctuation">}</span><span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//上传临时素材</span>
<span class="token function">uploadTemporaryMaterial</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> fileName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//获取文件绝对路径</span>
    <span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../media'</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取access_token</span>
            <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//定义请求地址</span>
            <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>api<span class="token punctuation">.</span>temporary<span class="token punctuation">.</span>upload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token punctuation">{</span>
                media<span class="token operator">:</span> <span class="token function">createReadStream</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//form表单方式发送请求</span>
            <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">rp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> json<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> formData<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将数据返回给用户</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'uploadTemporaryMaterial方法出了问题'</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="获取临时素材"><a href="#获取临时素材" class="headerlink" title="获取临时素材"></a>获取临时素材</h4><p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/offiaccount/Asset_Management/Get_temporary_materials.html">官方文档</a></p><p>wechat.js</p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//以流的方式接收</span>
<span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//fs模块 增加可写流</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>createReadStream<span class="token punctuation">,</span>createWriteStream<span class="token punctuation">}</span><span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//获取临时素材</span>
<span class="token function">getTemporaryMaterial</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> mediaId<span class="token punctuation">,</span> fileName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取文件绝对路径</span>
    <span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../media'</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取access_token</span>
            <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//定义请求地址</span>
            <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>api<span class="token punctuation">.</span>temporary<span class="token punctuation">.</span>get<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;media_id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mediaId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token comment">//判断是否为视频文件</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'video'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//视频文件只支持http协议</span>
                url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'https://'</span><span class="token punctuation">,</span> <span class="token string">'http://'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//发送请求</span>
                <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">rp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> json<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//其他类型</span>
                <span class="token function">request</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> resolve<span class="token punctuation">)</span> <span class="token comment">//当文件读取完毕时 可读流自动关闭 一旦关闭触发close事件 从而调用resolve方法通知外部文件读取完毕</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'getTemporaryMaterial方法出了问题'</span><span class="token operator">+</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="上传永久素材"><a href="#上传永久素材" class="headerlink" title="上传永久素材"></a>上传永久素材</h4><p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/offiaccount/Asset_Management/Adding_Permanent_Assets.html">官方文档</a></p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//path 模块 添加join方法</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>resolve<span class="token punctuation">,</span>join<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//上传永久素材</span>
<span class="token function">uploadPermanentMaterial</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> material<span class="token punctuation">,</span> body</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取access_token</span>
            <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//请求的配置对象</span>
            <span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
                method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
                json<span class="token operator">:</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//定义请求地址</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'news'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//上传图文消息</span>
                options<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>api<span class="token punctuation">.</span>permanent<span class="token punctuation">.</span>uploadNews<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                options<span class="token punctuation">.</span>body <span class="token operator">=</span> material<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'pic'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//上传图片</span>
                options<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>api<span class="token punctuation">.</span>permanent<span class="token punctuation">.</span>uploadImg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                options<span class="token punctuation">.</span>formData <span class="token operator">=</span> <span class="token punctuation">{</span>
                    media<span class="token operator">:</span> <span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../media'</span><span class="token punctuation">,</span> material<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//其他媒体素材</span>
                options<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>api<span class="token punctuation">.</span>permanent<span class="token punctuation">.</span>uploadOthers<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;type=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                options<span class="token punctuation">.</span>formData <span class="token operator">=</span> <span class="token punctuation">{</span>
                    media<span class="token operator">:</span> <span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../media'</span><span class="token punctuation">,</span> material<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//视频素材</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'video'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    options<span class="token punctuation">.</span>body <span class="token operator">=</span> body<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//发送请求</span>
            <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">rp</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将返回值返回出去</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'uploadPermanentMaterial方法出了问题'</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="获取永久素材"><a href="#获取永久素材" class="headerlink" title="获取永久素材"></a>获取永久素材</h4><p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/offiaccount/Asset_Management/Getting_Permanent_Assets.html">官方文档</a></p><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//获取永久素材</span>
<span class="token function">getPermanentMaterial</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> mediaId<span class="token punctuation">,</span> fileName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取access_token</span>
            <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//定义请求地址</span>
            <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>api<span class="token punctuation">.</span>permanent<span class="token punctuation">.</span>get<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> json<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>body<span class="token operator">:</span><span class="token punctuation">{</span>media_id<span class="token operator">:</span>mediaId<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'video'</span><span class="token operator">||</span><span class="token string">'news'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//发送请求</span>
                <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">rp</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span><span class="token string">'../media'</span><span class="token punctuation">,</span>fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> resolve<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'getPermanentMaterial方法出了问题'</span><span class="token operator">+</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="封装上传素材函数"><a href="#封装上传素材函数" class="headerlink" title="封装上传素材函数"></a>封装上传素材函数</h3><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">//上传素材</span>
<span class="token function">uploadMaterial</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> material<span class="token punctuation">,</span> body<span class="token punctuation">,</span> isPermanent <span class="token operator">=</span> <span class="token boolean">true</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取access_token</span>
            <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//请求的配置对象</span>
            <span class="token keyword">let</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
                method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
                json<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                formData <span class="token operator">:</span> <span class="token punctuation">{</span>
                    media<span class="token operator">:</span> <span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../media'</span><span class="token punctuation">,</span> material<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isPermanent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//永久素材</span>
                <span class="token comment">//定义请求地址</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'news'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//上传图文消息</span>
                    options<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>api<span class="token punctuation">.</span>permanent<span class="token punctuation">.</span>uploadNews<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                    options<span class="token punctuation">.</span>body <span class="token operator">=</span> material<span class="token punctuation">;</span>
                    options<span class="token punctuation">.</span>formData <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'pic'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//上传图片</span>
                    options<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>api<span class="token punctuation">.</span>permanent<span class="token punctuation">.</span>uploadImg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">//其他媒体素材</span>
                    options<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>api<span class="token punctuation">.</span>permanent<span class="token punctuation">.</span>uploadOthers<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;type=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
                    <span class="token comment">//视频素材</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'video'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        options<span class="token punctuation">.</span>body <span class="token operator">=</span> body<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                <span class="token comment">//临时素材</span>
                <span class="token comment">//定义请求地址</span>
                options<span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>api<span class="token punctuation">.</span>temporary<span class="token punctuation">.</span>upload<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//发送请求</span>
            <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">rp</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将返回值返回出去</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'uploadPermanentMaterial方法出了问题'</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者: </i></span><span class="reprint-info"><a href="/liaojie.github.io/about" rel="external nofollow noreferrer">liaojie</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接: </i></span><span class="reprint-info"><a href="https://liaojie.github.io.git/liaojie.github.io/2022/01/22/wei-xin-gong-zhong-hao/">https://liaojie.github.io.git/liaojie.github.io/2022/01/22/wei-xin-gong-zhong-hao/</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明: </i></span><span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/liaojie.github.io/about" target="_blank">liaojie</a> !</span></div></div><script async defer>document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/liaojie.github.io/tags/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7/"><span class="chip bg-color">微信公众号</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" type="text/css" href="/liaojie.github.io/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="/liaojie.github.io/libs/share/js/social-share.min.js"></script></div></div></div><style>#reward{margin:40px 0;text-align:center}#reward .reward-link{font-size:1.4rem;line-height:38px}#reward .btn-floating:hover{box-shadow:0 6px 12px rgba(0,0,0,.2),0 5px 15px rgba(0,0,0,.2)}#rewardModal{width:320px;height:350px}#rewardModal .reward-title{margin:15px auto;padding-bottom:5px}#rewardModal .modal-content{padding:10px}#rewardModal .close{position:absolute;right:15px;top:15px;color:rgba(0,0,0,.5);font-size:1.3rem;line-height:20px;cursor:pointer}#rewardModal .close:hover{color:#ef5350;transform:scale(1.3);-moz-transform:scale(1.3);-webkit-transform:scale(1.3);-o-transform:scale(1.3)}#rewardModal .reward-tabs{margin:0 auto;width:210px}.reward-tabs .tabs{height:38px;margin:10px auto;padding-left:0}.reward-content ul{padding-left:0!important}.reward-tabs .tabs .tab{height:38px;line-height:38px}.reward-tabs .tab a{color:#fff;background-color:#ccc}.reward-tabs .tab a:hover{background-color:#ccc;color:#fff}.reward-tabs .wechat-tab .active{color:#fff!important;background-color:#22ab38!important}.reward-tabs .alipay-tab .active{color:#fff!important;background-color:#019fe8!important}.reward-tabs .reward-img{width:210px;height:210px}</style><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="/liaojie.github.io/medias/loading.gif" data-original="/liaojie.github.io/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="/liaojie.github.io/medias/loading.gif" data-original="/liaojie.github.io/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function(){$(".tabs").tabs()})</script></div></div><link rel="stylesheet" href="/liaojie.github.io/libs/gitalk/gitalk.css"><link rel="stylesheet" href="/liaojie.github.io/css/my-gitalk.css"><div class="card gitalk-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;padding-left:20px;top:15px;padding-bottom:5px"><i class="fas fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="gitalk-container" class="card-content"></div></div><script src="/liaojie.github.io/libs/gitalk/gitalk.min.js"></script><script>let gitalk = new Gitalk({
        clientID: 'eedac85cd6c0645124b2',
        clientSecret: '0cbb1e584813da4a45008d2c6048fc84846ef93f',
        repo: 'liaojie1314-gitalk',
        owner: 'liaojie1314',
        admin: "liaojie1314",
        id: '2022-01-22T12-04-53',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');</script><div class="livere-card card" data-aos="fade-up"><div id="lv-container" class="card-content" data-id="city" data-uid="MTAyMC81NDUzMy8zMTAwNA=="><script type="text/javascript">(function (d, s) {
                let j, e = d.getElementsByTagName(s)[0];
                if (typeof LivereTower === 'function') {
                    return;
                }

                j = d.createElement(s);
                j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                j.async = true;

                e.parentNode.insertBefore(j, e);
            })(document, 'script');</script><noscript>为正常使用来必力评论功能请激活JavaScript。</noscript></div></div><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i>&nbsp;上一篇</div><div class="card"><a href="/liaojie.github.io/2022/01/22/wei-xin-xiao-cheng-xu/"><div class="card-image"><img src="/liaojie.github.io/medias/loading.gif" data-original="/liaojie.github.io/medias/featureimages/16.jpg" class="responsive-img" alt="微信小程序"> <span class="card-title">微信小程序</span></div></a><div class="card-content article-content"><div class="summary block-with-text"></div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2022-01-22 </span><span class="publish-author"><i class="fas fa-user fa-fw"></i> lj</span></div></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/liaojie.github.io/2022/01/21/shu-xue-jian-mo/"><div class="card-image"><img src="/liaojie.github.io/medias/loading.gif" data-original="/liaojie.github.io/medias/featureimages/13.jpg" class="responsive-img" alt="数学建模"> <span class="card-title">数学建模</span></div></a><div class="card-content article-content"><div class="summary block-with-text"></div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2022-01-21 </span><span class="publish-author"><i class="fas fa-user fa-fw"></i> lj</span></div></div></div></div></div></article></div><script type="text/javascript" src="/liaojie.github.io/libs/codeBlock/codeBlockFuction.js"></script><script type="text/javascript" src="/liaojie.github.io/libs/codeBlock/codeLang.js"></script><script type="text/javascript" src="/liaojie.github.io/libs/codeBlock/codeCopy.js"></script><script type="text/javascript" src="/liaojie.github.io/libs/codeBlock/codeShrink.js"></script></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget card" style="background-color:#fff"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="/liaojie.github.io/libs/tocbot/tocbot.min.js"></script><script>$(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });</script></main><footer class="page-footer bg-color"><div class="container row center-align" style="margin-bottom:15px!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2021-2022</span> <span id="year">2021</span> <a href="/liaojie.github.io/about" target="_blank">lj</a><br>&nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span class="white-color">287.9k</span>&nbsp;字 <span id="busuanzi_container_site_pv">|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>&nbsp;次 </span><span id="busuanzi_container_site_uv">|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span>&nbsp;人</span><br><span id="sitetime">载入运行时间...</span><script>function siteTime(){var e=36e5,t=24*e,n=new Date,o="2021",r=n.getFullYear(),a=n.getMonth()+1,i=n.getDate(),l=n.getHours(),m=n.getMinutes(),M=n.getSeconds(),g=Date.UTC(o,"10","18","0","0","0"),d=Date.UTC(r,a,i,l,m,M)-g,s=Math.floor(d/31536e6),u=Math.floor(d/t-365*s),T=Math.floor((d-(365*s+u)*t)/e),c=Math.floor((d-(365*s+u)*t-T*e)/6e4),f=Math.floor((d-(365*s+u)*t-T*e-6e4*c)/1e3);o==r?(document.getElementById("year").innerHTML=r,document.getElementById("sitetime").innerHTML="本站已安全运行 "+u+" 天 "+T+" 小时 "+c+" 分钟 "+f+" 秒"):(document.getElementById("year").innerHTML=o+" - "+r,document.getElementById("sitetime").innerHTML="本站已安全运行 "+s+" 年 "+u+" 天 "+T+" 小时 "+c+" 分钟 "+f+" 秒")}setInterval(siteTime,1e3)</script><br></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/liaojie1314" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github"></i> </a><a href="mailto:1517438366@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i> </a><a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1517438366" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1517438366" data-position="top" data-delay="50"><i class="fab fa-qq"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script type="text/javascript">$(function(){!function(t,i,s){"use strict";$.ajax({url:t,dataType:"xml",success:function(t){var e=$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),n=document.getElementById(i),r=document.getElementById(s);n.addEventListener("input",function(){var f='<ul class="search-result-list">',m=this.value.trim().toLowerCase().split(/[\s\-]+/);r.innerHTML="",this.value.trim().length<=0||(e.forEach(function(t){var n,e,r,i,s,l=!0,a=t.title.trim().toLowerCase(),c=t.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),u=0===(u=t.url).indexOf("/")?t.url:"/"+u,o=-1,h=-1;""!==a&&""!==c&&m.forEach(function(t,e){n=a.indexOf(t),o=c.indexOf(t),n<0&&o<0?l=!1:(o<0&&(o=0),0===e&&(h=o))}),l&&(f+="<li><a href='"+u+"' class='search-result-title'>"+a+"</a>",e=t.content.trim().replace(/<[^>]+>/g,""),0<=h&&(i=h+80,(r=h-20)<0&&(r=0),0===r&&(i=100),i>e.length&&(i=e.length),s=e.substr(r,i),m.forEach(function(t){var e=new RegExp(t,"gi");s=s.replace(e,'<em class="search-keyword">'+t+"</em>")}),f+='<p class="search-result">'+s+"...</p>"),f+="</li>")}),f+="</ul>",r.innerHTML=f)})}})}("/liaojie.github.io/search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="/liaojie.github.io/libs/materialize/materialize.min.js"></script><script src="/liaojie.github.io/libs/masonry/masonry.pkgd.min.js"></script><script src="/liaojie.github.io/libs/aos/aos.js"></script><script src="/liaojie.github.io/libs/scrollprogress/scrollProgress.min.js"></script><script src="/liaojie.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="/liaojie.github.io/js/matery.js"></script><script type="text/javascript" color="122 103 238" opacity="0.7" zindex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script><script type="text/javascript">var st,OriginTitile=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="ヽ(●-`Д´-)ノ你要玩捉迷藏嘛",clearTimeout(st)):(document.title="(Ő∀Ő3)ノ好哦！",st=setTimeout(function(){document.title=OriginTitile},3e3))})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/liaojie.github.io/libs/others/clicklove.js" async></script><script async src="/liaojie.github.io/libs/others/busuanzi.pure.mini.js"></script><script src="/liaojie.github.io/libs/instantpage/instantpage.js" type="module"></script><script>window.imageLazyLoadSetting={isSPA:!1,preloadRatio:1,processImages:null}</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})})</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var e=r[a],t=e,n=function(){r=r.filter(function(t){return e!==t})},i=new Image,o=t.getAttribute("data-original");i.onload=function(){t.src=o,n()},t.src!==o&&(i.src=o)}()}o(),n.addEventListener("scroll",function(){var t=o,e=n;clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this)</script></body></html>